====== Fichier : ./src/index.html ======
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Colisshare</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>
<body>
  <app-root></app-root>
</body>
</html>


====== Fichier : ./src/app/app.component.html ======
<!-- STRUCTURE GLOBALE -->
<div class="min-h-screen bg-gray-50">
  
  <!-- ================================ -->
  <!-- HEADER + MENU -->
  <!-- ================================ -->
  <header class="bg-white shadow-md border-b border-gray-200 sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3">
      
      <!-- Ligne principale du header -->
      <div class="flex items-center justify-between">
        
        <!-- LOGO -->
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full flex items-center justify-center text-white font-bold text-lg shadow-lg">
            TC
          </div>
          <div class="hidden sm:block">
            <h1 class="text-xl font-bold text-gray-900">Transport Collab</h1>
            <p class="text-xs text-gray-500">Gestion de flotte</p>
          </div>
        </div>

        <!-- MENU DESKTOP (masqu√© sur mobile) -->
        <nav class="hidden lg:flex items-center gap-2">
          <a 
            routerLink="/" 
            routerLinkActive="bg-blue-600 text-white shadow-lg" 
            [routerLinkActiveOptions]="{exact: true}"
            class="px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 transition-all duration-200">
            üè† Accueil
          </a>
          <a 
            routerLink="/voitures" 
            routerLinkActive="bg-blue-600 text-white shadow-lg"
            class="px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 transition-all duration-200">
            üöó Voitures
          </a>
          <a 
            routerLink="/trajets/historique" 
            routerLinkActive="bg-blue-600 text-white shadow-lg"
            class="px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 transition-all duration-200">
            üìã Historique
          </a>
          <a 
            routerLink="/collaborations/demandes" 
            routerLinkActive="bg-blue-600 text-white shadow-lg"
            class="px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 transition-all duration-200">
            ü§ù Collaborations
          </a>
          <a 
            routerLink="/chat" 
            routerLinkActive="bg-blue-600 text-white shadow-lg"
            class="px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-blue-50 transition-all duration-200">
            üí¨ Chat
          </a>
        </nav>

        <!-- BOUTON BURGER MOBILE -->
        <button 
          (click)="toggleMenu()" 
          class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors"
          type="button">
          <svg *ngIf="!menuOpen" class="w-7 h-7 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
          <svg *ngIf="menuOpen" class="w-7 h-7 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- MENU MOBILE DROPDOWN -->
      <nav *ngIf="menuOpen" class="lg:hidden mt-4 pb-4 space-y-2 border-t pt-4">
        <a 
          routerLink="/" 
          (click)="toggleMenu()"
          routerLinkActive="bg-blue-600 text-white"
          [routerLinkActiveOptions]="{exact: true}"
          class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
          <span class="text-2xl">üè†</span>
          <span>Accueil</span>
        </a>
        <a 
          routerLink="/voitures" 
          (click)="toggleMenu()"
          routerLinkActive="bg-blue-600 text-white"
          class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
          <span class="text-2xl">üöó</span>
          <span>Gestion des Voitures</span>
        </a>
        <a 
          routerLink="/trajets/saisie" 
          (click)="toggleMenu()"
          routerLinkActive="bg-blue-600 text-white"
          class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
          <span class="text-2xl">‚ûï</span>
          <span>Nouveau Trajet</span>
        </a>
        <a 
          routerLink="/trajets/historique" 
          (click)="toggleMenu()"
          routerLinkActive="bg-blue-600 text-white"
          class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
          <span class="text-2xl">üìã</span>
          <span>Historique des Trajets</span>
        </a>
        <a 
          routerLink="/collaborations/demandes" 
          (click)="toggleMenu()"
          routerLinkActive="bg-blue-600 text-white"
          class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
          <span class="text-2xl">ü§ù</span>
          <span>Demandes de Collab</span>
        </a>
        <a 
          routerLink="/chat" 
          (click)="toggleMenu()"
          routerLinkActive="bg-blue-600 text-white"
          class="flex items-center gap-3 px-4 py-3 rounded-lg font-medium hover:bg-gray-50 transition-colors">
          <span class="text-2xl">üí¨</span>
          <span>Chat</span>
        </a>
      </nav>

    </div>
  </header>

  <!-- ================================ -->
  <!-- CONTENU PRINCIPAL -->
  <!-- ================================ -->
  <main class="container mx-auto px-4 py-6">
    <router-outlet></router-outlet>
  </main>

  <!-- ================================ -->
  <!-- FOOTER -->
  <!-- ================================ -->
  <footer class="bg-white border-t border-gray-200 mt-12 py-6">
    <div class="container mx-auto px-4 text-center">
      <p class="text-sm text-gray-600">¬© 2025 Transport Collab - Tous droits r√©serv√©s</p>
    </div>
  </footer>

</div>


====== Fichier : ./src/app/app-routing.module.ts ======
import { NgModule } from '@angular/core';
import { RouterModule, Routes } from '@angular/router';

import { CarsManagementPageComponent } from './pages/cars-management/cars-management-page.component';
import { TripFormPageComponent } from './pages/trip-form/trip-form-page.component';
import { TripsHistoryPageComponent } from './pages/trips-history/trips-history-page.component';
import { CollaborationRequestsPageComponent } from './pages/collab-requests/collab-requests-page.component';
import { ChatPageComponent } from './pages/chat-page/chat-page.component';

const routes: Routes = [
  { path: '', redirectTo: 'trajets/saisie', pathMatch: 'full' },
  { path: 'voitures', component: CarsManagementPageComponent },
  { path: 'trajets/saisie', component: TripFormPageComponent },
  { path: 'trajets/historique', component: TripsHistoryPageComponent },
  { path: 'collaborations/demandes', component: CollaborationRequestsPageComponent },
  { path: 'chat', component: ChatPageComponent },
  { path: '**', redirectTo: 'trajets/saisie' },
];

@NgModule({
  imports: [RouterModule.forRoot(routes)],
  exports: [RouterModule],
})
export class AppRoutingModule {}


====== Fichier : ./src/app/app.routes.ts ======
import { Routes } from '@angular/router';
import { HomePageComponent } from './pages/home/home-page.component';
import { CollaborationRequestsPageComponent } from './pages/collab-requests/collab-requests-page.component';
import { TripFormPageComponent } from './pages/trip-form/trip-form-page.component';
import { TripsHistoryPageComponent } from './pages/trips-history/trips-history-page.component';
import { CarsManagementPageComponent } from './pages/cars-management/cars-management-page.component';
import { ChatPageComponent } from './pages/chat-page/chat-page.component';
import { authGuard } from './auth.guard';

export const routes: Routes = [
  // Page publique (Login/Signup)
  { 
    path: '', 
    component: HomePageComponent 
  },
  
  // Pages prot√©g√©es (n√©cessitent AuthGuard)
  { 
    path: 'collaborations/demandes', 
    component: CollaborationRequestsPageComponent, 
    canActivate: [authGuard] 
  },
  { 
    path: 'trajets/saisie', 
    component: TripFormPageComponent, 
    canActivate: [authGuard] 
  },
  { 
    path: 'trajets/historique', 
    component: TripsHistoryPageComponent, 
    canActivate: [authGuard] 
  },
  { 
    path: 'voitures', 
    component: CarsManagementPageComponent, 
    canActivate: [authGuard] 
  },
  { 
    path: 'chat', 
    component: ChatPageComponent, 
    canActivate: [authGuard] 
  },

  // Redirection par d√©faut (si URL inconnue)
  { 
    path: '**', 
    redirectTo: '' 
  }
];


====== Fichier : ./src/app/app.ts ======
import { Component, signal } from '@angular/core';
import { RouterOutlet } from '@angular/router';

@Component({
  selector: 'app-root',
  imports: [RouterOutlet],
  templateUrl: './app.html',
  styleUrl: './app.css'
})
export class App {
  protected readonly title = signal('colisshare');
}


====== Fichier : ./src/app/app.css ======


====== Fichier : ./src/app/auth.guard.ts ======
import { inject } from '@angular/core';
import { CanActivateFn, Router } from '@angular/router';
import { AuthService } from './services/auth.service';
import { map, skipWhile, take, tap } from 'rxjs/operators';

export const authGuard: CanActivateFn = (route, state) => {
  const auth = inject(AuthService);
  const router = inject(Router);

  // user$ √©met null au d√©but avant de v√©rifier le token local.
  // On ne veut PAS prendre cette premi√®re valeur "null" par d√©faut si Firebase est en train de charger.
  // Mais authState() g√®re √ßa bien g√©n√©ralement.
  // Si le probl√®me persiste, c'est souvent que le Guard s'ex√©cute TROP vite.
  
  return auth.user$.pipe(
    take(1), 
    tap(user => {
      // Log pour debug
      if (!user) {
        console.log('üîí AuthGuard: Pas d\'utilisateur -> Redirection Login');
        router.navigate(['/']);
      }
    }),
    map(user => !!user)
  );
};


====== Fichier : ./src/app/app.component.ts ======
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterOutlet } from '@angular/router';
import { HeaderComponent } from './components/header/header.component';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, RouterOutlet, HeaderComponent],
  template: `
    <!-- Le Header g√®re sa propre visibilit√© (il se cache si user$ est null) -->
    <app-header></app-header>
    
    <!-- Le contenu des pages s'affiche ici -->
    <router-outlet></router-outlet>
  `
})
export class AppComponent {}


====== Fichier : ./src/app/components/chat/chat.component.css ======
/* Styles du composant Chat */
:host {
  display: block;
  height: 100%;
}

/* Scrollbar personnalis√©e */
.overflow-y-auto::-webkit-scrollbar {
  width: 6px;
}

.overflow-y-auto::-webkit-scrollbar-track {
  background: #f1f1f1;
}

.overflow-y-auto::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 3px;
}

.overflow-y-auto::-webkit-scrollbar-thumb:hover {
  background: #555;
}


====== Fichier : ./src/app/components/chat/chat.component.ts ======
import { Component, OnInit, OnDestroy, Input } from '@angular/core';
import { CommonModule, DatePipe } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { Subscription } from 'rxjs';
import { ChatService, ChatMessage } from '../../services/chat.service';

@Component({
  selector: 'app-chat',
  standalone: true,
  imports: [CommonModule, FormsModule, DatePipe],
  templateUrl: './chat.component.html',
  // styleUrls supprim√© ‚úÖ
})
export class ChatComponent implements OnInit, OnDestroy {
  @Input() conversationId!: string;
  @Input() currentUserId!: string;

  messages: ChatMessage[] = [];
  draft = '';
  sending = false;
  private subscription?: Subscription;

  constructor(private chatService: ChatService) {}

  ngOnInit(): void {
    if (!this.conversationId || !this.currentUserId) {
      console.error('‚ùå conversationId ou currentUserId manquant !');
      return;
    }

    // √âcouter les messages en temps r√©el
    this.subscription = this.chatService
      .getMessages(this.conversationId)
      .subscribe({
        next: (msgs: ChatMessage[]) => {
          this.messages = msgs;
          console.log('üí¨ Messages re√ßus:', msgs.length);
        },
        error: (err: any) => {
          console.error('‚ùå Erreur chat:', err);
        },
      });
  }

  ngOnDestroy(): void {
    this.subscription?.unsubscribe();
  }

  async sendMessage(): Promise<void> {
    const text = this.draft.trim();
    if (!text || this.sending) return;

    this.sending = true;
    try {
      await this.chatService.sendMessage(
        this.conversationId,
        this.currentUserId,
        text
      );
      this.draft = '';
      console.log('‚úÖ Message envoy√©');
    } catch (error: any) {
      console.error('‚ùå Erreur envoi:', error);
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.sending = false;
    }
  }

  trackByMsgId(index: number, msg: ChatMessage): string {
    return msg.id || `msg-${index}`;
  }
}


====== Fichier : ./src/app/components/chat/chat.component.html ======
<div class="flex flex-col h-full bg-gray-50">
  <!-- Header -->
  <div class="bg-blue-600 text-white p-4 shadow-md">
    <h3 class="text-lg font-semibold">üí¨ Chat</h3>
  </div>

  <!-- Messages -->
  <div class="flex-1 overflow-y-auto p-4 space-y-3">
    <div *ngIf="messages.length === 0" class="h-full flex items-center justify-center text-gray-400">
      Aucun message pour le moment
    </div>

    <div
      *ngFor="let msg of messages; trackBy: trackByMsgId"
      class="flex"
      [ngClass]="msg.senderId === currentUserId ? 'justify-end' : 'justify-start'"
    >
      <div
        class="max-w-xs px-4 py-2 rounded-lg shadow"
        [ngClass]="
          msg.senderId === currentUserId
            ? 'bg-blue-500 text-white'
            : 'bg-white text-gray-800'
        "
      >
        <p class="text-sm">{{ msg.text }}</p>
        <span class="text-xs opacity-75 mt-1 block">
          {{ msg.createdAt | date: 'shortTime' }}
        </span>
      </div>
    </div>
  </div>

  <!-- Input -->
  <div class="bg-white border-t p-3 flex space-x-2">
    <input
      type="text"
      [(ngModel)]="draft"
      (keydown.enter)="sendMessage()"
      placeholder="√âcrire un message..."
      class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
      [disabled]="sending"
    />
    <button
      (click)="sendMessage()"
      [disabled]="!draft.trim() || sending"
      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 transition"
    >
      <span *ngIf="!sending">Envoyer</span>
      <span *ngIf="sending">...</span>
    </button>
  </div>
</div>


====== Fichier : ./src/app/components/layout/layout.component.html ======
<div class="min-h-screen bg-gray-100 flex flex-col">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <!-- Logo et titre -->
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold">
          T
        </div>
        <div>
          <p class="text-sm font-semibold text-gray-800">Transport Collab</p>
          <p class="text-[11px] text-gray-500">Dashboard</p>
        </div>
      </div>

      <!-- Navigation -->
      <nav class="flex-1">
        <ul class="flex flex-wrap justify-end gap-2 text-xs">
          <li>
            <a
              routerLink="/"
              [routerLinkActive]="'bg-blue-50 text-blue-700'"
              [routerLinkActiveOptions]="{ exact: true }"
              class="inline-flex items-center px-3 py-2 rounded-lg border border-transparent hover:bg-gray-50 text-gray-700"
            >
              Accueil
            </a>
          </li>
          <li>
            <a
              routerLink="/voitures"
              [routerLinkActive]="'bg-blue-50 text-blue-700'"
              class="inline-flex items-center px-3 py-2 rounded-lg border border-transparent hover:bg-gray-50 text-gray-700"
            >
              Gestion des voitures
            </a>
          </li>
          <li>
            <a
              routerLink="/trajets/saisie"
              [routerLinkActive]="'bg-blue-50 text-blue-700'"
              class="inline-flex items-center px-3 py-2 rounded-lg border border-transparent hover:bg-gray-50 text-gray-700"
            >
              Saisie de trajet
            </a>
          </li>
          <li>
            <a
              routerLink="/trajets/historique"
              [routerLinkActive]="'bg-blue-50 text-blue-700'"
              class="inline-flex items-center px-3 py-2 rounded-lg border border-transparent hover:bg-gray-50 text-gray-700"
            >
              Historique des trajets
            </a>
          </li>
          <li>
            <a
              routerLink="/collaborations/demandes"
              [routerLinkActive]="'bg-blue-50 text-blue-700'"
              class="inline-flex items-center px-3 py-2 rounded-lg border border-transparent hover:bg-gray-50 text-gray-700"
            >
              Demandes de collab
            </a>
          </li>
          <li>
            <a
              routerLink="/chat"
              [routerLinkActive]="'bg-blue-50 text-blue-700'"
              class="inline-flex items-center px-3 py-2 rounded-lg border border-transparent hover:bg-gray-50 text-gray-700"
            >
              Chat
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Contenu principal -->
  <main class="flex-1 max-w-6xl mx-auto w-full">
    <router-outlet></router-outlet>
  </main>
</div>


====== Fichier : ./src/app/components/layout/layout.component.ts ======
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterOutlet, RouterLink, RouterLinkActive } from '@angular/router';

@Component({
  standalone: true,
  selector: 'app-layout',
  templateUrl: './layout.component.html',
  imports: [CommonModule, RouterOutlet, RouterLink, RouterLinkActive],
})
export class LayoutComponent {}


====== Fichier : ./src/app/components/car-management/car-management.component.html ======
<div class="p-6">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üöó Gestion du Parc Automobile</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-semibold mb-4 text-blue-600">{{ isEditing ? 'Modifier la Voiture' : 'Ajouter une Nouvelle Voiture' }}</h3>
            
            <form [formGroup]="carForm" (ngSubmit)="onSubmit()" class="space-y-4">
                
                <div>
                    <label for="licensePlate" class="block text-sm font-medium text-gray-700">Plaque d'Immatriculation</label>
                    <input id="licensePlate" type="text" formControlName="licensePlate" 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500" 
                           placeholder="Ex: AA-123-BB">
                    <div *ngIf="carForm.get('licensePlate')?.invalid && carForm.get('licensePlate')?.touched" class="text-red-500 text-xs mt-1">
                        La plaque est obligatoire.
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="make" class="block text-sm font-medium text-gray-700">Marque</label>
                        <input id="make" type="text" formControlName="make" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="model" class="block text-sm font-medium text-gray-700">Mod√®le</label>
                        <input id="model" type="text" formControlName="model" 
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>

                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700">Ann√©e</label>
                    <input id="year" type="number" formControlName="year" 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>

                <div>
                    <label for="assignedDriverId" class="block text-sm font-medium text-gray-700">ID Chauffeur Assign√© (Optionnel)</label>
                    <input id="assignedDriverId" type="text" formControlName="assignedDriverId" 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                </div>

                <div class="flex items-center">
                    <input id="isOperational" type="checkbox" formControlName="isOperational" 
                           class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                    <label for="isOperational" class="ml-2 block text-sm font-medium text-gray-700">
                        Op√©rationnelle
                    </label>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="submit" [disabled]="carForm.invalid"
                            class="flex-1 px-4 py-2 text-white font-semibold rounded-md shadow transition duration-150"
                            [ngClass]="carForm.invalid ? 'bg-gray-400' : 'bg-blue-600 hover:bg-blue-700'">
                        {{ isEditing ? 'Sauvegarder les Modifications' : 'Ajouter la Voiture' }}
                    </button>

                    <button type="button" *ngIf="isEditing" (click)="initForm()"
                            class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md shadow hover:bg-gray-300 transition duration-150">
                        Annuler / Nouveau
                    </button>
                </div>

            </form>
        </div>

        <div class="lg:col-span-2">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Liste des Voitures</h3>
            
            <div *ngIf="(cars$ | async) as cars; else loading" class="space-y-3">
                
                <div *ngIf="cars.length === 0" class="p-4 text-center text-gray-500 bg-white rounded-lg shadow-inner">
                    Aucune voiture enregistr√©e.
                </div>

                <div *ngFor="let car of cars" 
                     class="bg-white p-4 rounded-lg shadow flex items-center justify-between transition duration-150 hover:shadow-lg"
                     [ngClass]="{'border-l-4 border-blue-500': selectedCarId === car.id, 'border-l-4 border-gray-200': selectedCarId !== car.id}">
                    
                    <div>
                        <p class="text-lg font-bold text-gray-900">{{ car.brand }} {{ car.model }}</p>
                        <p class="text-sm text-gray-600">Plaque: {{ car.licensePlate }}</p>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full"
                              [ngClass]="car.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                            {{ car.active ? 'Op√©rationnelle' : 'Maintenance' }}
                        </span>
                    </div>

                    <div class="space-x-2">
                        <button (click)="onSelectCar(car)" 
                                class="text-blue-600 hover:text-blue-800 p-2 rounded hover:bg-blue-50 transition duration-150"
                                title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button (click)="onDeleteCar(car.id!)" 
                                class="text-red-600 hover:text-red-800 p-2 rounded hover:bg-red-50 transition duration-150"
                                title="Supprimer">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <ng-template #loading>
                <div class="text-center p-4 text-gray-500">Chargement des voitures...</div>
            </ng-template>
        </div>

    </div>
</div>


====== Fichier : ./src/app/components/car-management/car-management.component.ts ======
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import {
  FormBuilder,
  FormGroup,
  Validators,
  ReactiveFormsModule,
} from '@angular/forms';
import { Observable } from 'rxjs';
import { FirestoreService } from '../../services/firestore.service';
import { Car } from '../../interfaces/car.interface';

@Component({
  selector: 'app-car-management',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule],
  templateUrl: './car-management.component.html',
})
export class CarManagementComponent implements OnInit {
  private readonly COMPANY_ID = 'AbC1dE2fG3hI4jK5lM6n';

  cars$!: Observable<Car[]>;
  carForm!: FormGroup;
  editingCar: Car | null = null;
  selectedCarId: string | null = null;
  loading = false;

  get isEditing(): boolean {
    return !!this.editingCar;
  }

  constructor(
    private fb: FormBuilder,
    private firestoreService: FirestoreService
  ) {}

  ngOnInit(): void {
    this.initForm();
    this.loadCars();
  }

  initForm(): void {
    this.carForm = this.fb.group({
      make: ['', Validators.required],
      model: ['', Validators.required],
      year: ['', [Validators.required, Validators.min(1900)]],
      licensePlate: ['', Validators.required],
      capacity: ['', [Validators.required, Validators.min(1)]],
      active: [true],
    });
    this.editingCar = null;
    this.selectedCarId = null;
  }

  loadCars(): void {
    this.cars$ = this.firestoreService.getCars(this.COMPANY_ID);
  }

  onSelectCar(car: Car): void {
    this.selectedCarId = car.id || null;
    this.editCar(car);
  }

  editCar(car: Car): void {
    this.editingCar = car;
    this.selectedCarId = car.id || null;
    this.carForm.patchValue(car);
  }

  async onDeleteCar(carId: string): Promise<void> {
    if (!confirm('üóëÔ∏è Supprimer cette voiture ?')) return;

    this.loading = true;
    try {
      await this.firestoreService.deleteCar(carId);
      alert('‚úÖ Voiture supprim√©e !');
      this.selectedCarId = null;
    } catch (error: any) {
      console.error('‚ùå Erreur:', error);
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.loading = false;
    }
  }

  async deleteCar(carId: string): Promise<void> {
    await this.onDeleteCar(carId);
  }

  async onSubmit(): Promise<void> {
    if (this.carForm.invalid) {
      alert('‚ö†Ô∏è Veuillez remplir tous les champs requis.');
      return;
    }

    this.loading = true;

    try {
      if (this.editingCar?.id) {
        // UPDATE
        const carToUpdate = {
          id: this.editingCar.id,
          ...this.carForm.value,
        };
        await this.firestoreService.updateCar(carToUpdate);
        alert('‚úÖ Voiture mise √† jour !');
      } else {
        // CREATE
        const carData = this.carForm.value;
        await this.firestoreService.addCar(carData);
        alert('‚úÖ Voiture ajout√©e !');
      }

      this.initForm();
    } catch (error: any) {
      console.error('‚ùå Erreur:', error);
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.loading = false;
    }
  }

  cancelEdit(): void {
    this.initForm();
  }
}


====== Fichier : ./src/app/components/trip-entry/trip-entry.component.ts ======
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import {
  FormBuilder,
  FormGroup,
  Validators,
  ReactiveFormsModule,
  FormArray,
} from '@angular/forms';
import { Observable } from 'rxjs';
import { Timestamp } from '@angular/fire/firestore';
import { FirestoreService } from '../../services/firestore.service';
import { Car } from '../../interfaces/car.interface';
import { TripStep } from '../../interfaces/trip.interface';
import { CitySelectComponent } from '../city-select/city-select.component';

@Component({
  selector: 'app-trip-entry',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, CitySelectComponent],
  templateUrl: './trip-entry.component.html',
})
export class TripEntryComponent implements OnInit {
  private readonly COMPANY_ID = 'AbC1dE2fG3hI4jK5lM6n';
  private readonly DRIVER_ID = 'UIDCurrentDriver';

  tripForm!: FormGroup;
  availableCars$!: Observable<Car[]>;
  loading = false;
  successMessage = '';
  errorMessage = '';

  constructor(
    private fb: FormBuilder,
    private firestoreService: FirestoreService,
    private router: Router
  ) {}

  ngOnInit(): void {
    this.initForm();
    this.availableCars$ = this.firestoreService.getCars(this.COMPANY_ID);
  }

  initForm(): void {
    this.tripForm = this.fb.group({
      carId: ['', Validators.required],
      departureCity: ['', Validators.required],
      arrivalCity: ['', Validators.required],
      estimatedDepartureTime: ['', Validators.required],
      estimatedArrivalTime: ['', Validators.required],
      steps: this.fb.array([]),
    });
  }

  get steps(): FormArray {
    return this.tripForm.get('steps') as FormArray;
  }

  createStepGroup(step?: TripStep): FormGroup {
    return this.fb.group({
      city: [step?.city || '', Validators.required],
      estimatedTime: [step?.estimatedTime || '', Validators.required],
    });
  }

  addStep(): void {
    this.steps.push(this.createStepGroup());
  }

  removeStep(index: number): void {
    this.steps.removeAt(index);
  }

  cancelForm(): void {
    const hasData =
      this.tripForm.dirty ||
      this.tripForm.value.carId ||
      this.tripForm.value.departureCity;

    if (hasData) {
      if (
        confirm(
          'üö´ Voulez-vous vraiment annuler ? Les modifications seront perdues.'
        )
      ) {
        this.tripForm.reset();
        this.router.navigate(['/trajets/historique']);
      }
    } else {
      this.router.navigate(['/trajets/historique']);
    }
  }

  async onSubmit(): Promise<void> {
    // R√©initialiser les messages
    this.successMessage = '';
    this.errorMessage = '';

    if (this.tripForm.invalid) {
      this.errorMessage = '‚ö†Ô∏è Veuillez remplir tous les champs requis.';
      this.markFormGroupTouched(this.tripForm);
      
      // Afficher aussi une alerte
      alert(this.errorMessage);
      return;
    }

    this.loading = true;

    const formValue = this.tripForm.value;
    const tripData = {
      carId: formValue.carId,
      companyId: this.COMPANY_ID,
      driverId: this.DRIVER_ID,
      departureCity: formValue.departureCity,
      arrivalCity: formValue.arrivalCity,
      estimatedDepartureTime: Timestamp.fromDate(
        new Date(formValue.estimatedDepartureTime)
      ),
      estimatedArrivalTime: Timestamp.fromDate(
        new Date(formValue.estimatedArrivalTime)
      ),
      status: 'pending' as const,
      steps: formValue.steps || [],
    };

    try {
      const tripId = await this.firestoreService.addTrip(tripData);
      
      // Message de succ√®s
      this.successMessage = `‚úÖ Trajet enregistr√© avec succ√®s ! (ID: ${tripId})`;
      console.log('‚úÖ Trajet cr√©√©:', tripId, tripData);

      // Afficher une alerte de confirmation
      alert(`‚úÖ Trajet enregistr√© avec succ√®s !\n\nüìç ${tripData.departureCity} ‚Üí ${tripData.arrivalCity}\nüöó Voiture: ${tripData.carId}\nüìÖ D√©part: ${formValue.estimatedDepartureTime}`);

      // Reset le formulaire
      this.tripForm.reset();

      // Rediriger apr√®s 2 secondes
      setTimeout(() => {
        this.router.navigate(['/trajets/historique']);
      }, 2000);

    } catch (error: any) {
      console.error('‚ùå Erreur lors de l\'enregistrement:', error);
      this.errorMessage = `‚ùå Erreur: ${error.message || 'Impossible d\'enregistrer le trajet'}`;
      
      // Afficher une alerte d'erreur
      alert(this.errorMessage);
    } finally {
      this.loading = false;
    }
  }

  private markFormGroupTouched(formGroup: FormGroup): void {
    Object.keys(formGroup.controls).forEach((key) => {
      const control = formGroup.get(key);
      control?.markAsTouched();

      if (control instanceof FormGroup) {
        this.markFormGroupTouched(control);
      }
    });
  }
}


====== Fichier : ./src/app/components/trip-entry/trip-entry.component.html ======
<div class="p-6">
  <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">
    üìù Enregistrement d'un Nouveau Trajet
  </h2>

  <!-- MESSAGES DE SUCC√àS/ERREUR -->
  <div *ngIf="successMessage" class="mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg flex items-center gap-3 animate-pulse">
    <span class="text-2xl">‚úÖ</span>
    <span class="font-medium">{{ successMessage }}</span>
  </div>

  <div *ngIf="errorMessage" class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-center gap-3">
    <span class="text-2xl">‚ùå</span>
    <span class="font-medium">{{ errorMessage }}</span>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl mx-auto">
    <form [formGroup]="tripForm" (ngSubmit)="onSubmit()" class="space-y-6">
      
      <!-- Voiture -->
      <div>
        <label for="carId" class="block text-sm font-medium text-gray-700 mb-1">
          üöó Voiture Assign√©e <span class="text-red-500">*</span>
        </label>
        <select
          id="carId"
          formControlName="carId"
          class="w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          [class.border-red-500]="tripForm.get('carId')?.invalid && tripForm.get('carId')?.touched"
        >
          <option value="" disabled>S√©lectionner un v√©hicule</option>
          <ng-container *ngIf="availableCars$ | async as cars">
            <option *ngFor="let car of cars" [value]="car.id">
              {{ car.brand }} {{ car.model }} ({{ car.licensePlate }})
            </option>
          </ng-container>
        </select>
        <div
          *ngIf="tripForm.get('carId')?.invalid && tripForm.get('carId')?.touched"
          class="text-red-500 text-xs mt-1"
        >
          ‚ö†Ô∏è La s√©lection de la voiture est obligatoire.
        </div>
      </div>

      <!-- VILLES -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <app-city-select
            formControlName="departureCity"
            label="Ville de D√©part"
            icon="üöÄ"
            placeholder="Tapez pour rechercher..."
            [required]="true"
          ></app-city-select>
          <div
            *ngIf="tripForm.get('departureCity')?.invalid && tripForm.get('departureCity')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            ‚ö†Ô∏è La ville de d√©part est obligatoire.
          </div>
        </div>

        <div>
          <app-city-select
            formControlName="arrivalCity"
            label="Ville d'Arriv√©e"
            icon="üèÅ"
            placeholder="Tapez pour rechercher..."
            [required]="true"
          ></app-city-select>
          <div
            *ngIf="tripForm.get('arrivalCity')?.invalid && tripForm.get('arrivalCity')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            ‚ö†Ô∏è La ville d'arriv√©e est obligatoire.
          </div>
        </div>
      </div>

      <!-- Dates -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            ‚è∞ Heure de D√©part <span class="text-red-500">*</span>
          </label>
          <input
            type="datetime-local"
            formControlName="estimatedDepartureTime"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="tripForm.get('estimatedDepartureTime')?.invalid && tripForm.get('estimatedDepartureTime')?.touched"
          />
          <div
            *ngIf="tripForm.get('estimatedDepartureTime')?.invalid && tripForm.get('estimatedDepartureTime')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            ‚ö†Ô∏è L'heure de d√©part est obligatoire.
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            ‚è±Ô∏è Heure d'Arriv√©e <span class="text-red-500">*</span>
          </label>
          <input
            type="datetime-local"
            formControlName="estimatedArrivalTime"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="tripForm.get('estimatedArrivalTime')?.invalid && tripForm.get('estimatedArrivalTime')?.touched"
          />
          <div
            *ngIf="tripForm.get('estimatedArrivalTime')?.invalid && tripForm.get('estimatedArrivalTime')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            ‚ö†Ô∏è L'heure d'arriv√©e est obligatoire.
          </div>
        </div>
      </div>

      <!-- √âtapes -->
      <div class="border border-gray-200 p-4 rounded-lg bg-gray-50">
        <h4 class="text-lg font-semibold mb-3 text-gray-700">
          üõë √âtapes Interm√©diaires (Optionnel)
        </h4>
        <div formArrayName="steps" class="space-y-3">
          <div
            *ngFor="let stepGroup of steps.controls; let i = index"
            [formGroupName]="i"
            class="flex items-center gap-3 p-3 bg-white rounded shadow-sm"
          >
            <div class="flex-1">
              <input
                type="text"
                formControlName="city"
                placeholder="Ville de l'√©tape {{ i + 1 }}"
                class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div class="w-32">
              <input
                type="time"
                formControlName="estimatedTime"
                class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              type="button"
              (click)="removeStep(i)"
              class="text-red-500 hover:text-red-700 text-xl font-bold transition"
              title="Supprimer cette √©tape"
            >
              ‚úï
            </button>
          </div>
        </div>
        <button
          type="button"
          (click)="addStep()"
          class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition font-medium"
        >
          ‚ûï Ajouter une √©tape
        </button>
      </div>

      <!-- Boutons -->
      <div class="flex gap-4">
        <button
          type="submit"
          [disabled]="tripForm.invalid || loading"
          class="flex-1 px-6 py-3 text-white font-semibold rounded-lg shadow-md transition"
          [ngClass]="tripForm.invalid || loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
        >
          <span *ngIf="!loading">‚úÖ Enregistrer le Trajet</span>
          <span *ngIf="loading">‚è≥ Enregistrement en cours...</span>
        </button>

        <button
          type="button"
          (click)="cancelForm()"
          [disabled]="loading"
          class="px-8 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          ‚ùå Annuler
        </button>
      </div>
    </form>
  </div>
</div>


====== Fichier : ./src/app/components/dashboard/dashboard.component.html ======
<div class="flex h-screen bg-gray-100">

    <aside class="w-64 flex-shrink-0 bg-gray-800 text-white flex flex-col justify-between">
        
        <div class="p-4">
            <h1 class="text-2xl font-bold border-b border-gray-700 pb-3">
                <span class="text-blue-400">Colis</span>Share
            </h1>
            <div class="mt-4 space-y-2 text-sm text-gray-400">
                <p><i class="fas fa-truck mr-2"></i> Voitures Op√©: <span class="font-semibold text-blue-300">XX</span></p>
                <p><i class="fas fa-user-friends mr-2"></i> Chauffeurs: <span class="font-semibold text-blue-300">YY</span></p>
            </div>
        </div>
        
        <nav class="flex-grow p-4 space-y-2">
            <a routerLink="/dashboard/cars" routerLinkActive="bg-gray-700/50" class="flex items-center p-3 rounded-lg transition duration-200 hover:bg-gray-700">
                <i class="fas fa-car text-blue-400 w-6"></i>
                <span class="ml-3">Gestion des Voitures</span>
            </a>
            <a routerLink="/dashboard/trips" routerLinkActive="bg-gray-700/50" class="flex items-center p-3 rounded-lg transition duration-200 hover:bg-gray-700">
                <i class="fas fa-road text-blue-400 w-6"></i>
                <span class="ml-3">Saisie de Trajet</span>
            </a>
            <a routerLink="/dashboard/history" routerLinkActive="bg-gray-700/50" class="flex items-center p-3 rounded-lg transition duration-200 hover:bg-gray-700">
                <i class="fas fa-history text-blue-400 w-6"></i>
                <span class="ml-3">Historique des Trajets</span>
            </a>
            <a routerLink="/dashboard/collaborations" routerLinkActive="bg-gray-700/50" class="flex items-center p-3 rounded-lg transition duration-200 hover:bg-gray-700">
                <i class="fas fa-handshake text-blue-400 w-6"></i>
                <span class="ml-3">Demandes de Collab</span>
            </a>
            <a routerLink="/dashboard/chat" routerLinkActive="bg-gray-700/50" class="flex items-center p-3 rounded-lg transition duration-200 hover:bg-gray-700">
                <i class="fas fa-comments text-blue-400 w-6"></i>
                <span class="ml-3">Chat</span>
            </a>
        </nav>
        
        <div class="p-4 border-t border-gray-700">
            <button class="w-full flex items-center p-3 rounded-lg text-red-400 hover:bg-gray-700 transition duration-200">
                <i class="fas fa-sign-out-alt w-6"></i>
                <span class="ml-3">D√©connexion</span>
            </button>
        </div>
        
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        
        <header class="flex items-center justify-between p-4 bg-white shadow-md border-b">
            <h2 class="text-xl font-semibold text-gray-800">Application ColisShare</h2>
            <div class="flex items-center space-x-4">
                <i class="far fa-bell text-gray-600 hover:text-blue-500 cursor-pointer"></i>
                <div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm">PR</div>
            </div>
        </header>

        <main class="flex-1 overflow-x-hidden overflow-y-auto p-6">
            <router-outlet></router-outlet>
        </main>
        
    </div>
</div>


====== Fichier : ./src/app/components/dashboard/dashboard.component.ts ======
import { Component } from '@angular/core';
import { RouterLink, RouterOutlet } from '@angular/router';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-dashboard',
  standalone: true,
  imports: [CommonModule, RouterLink, RouterOutlet],
  templateUrl: './dashboard.component.html',
  styleUrls: [] // ‚¨ÖÔ∏è Correction
})
export class DashboardComponent {}


====== Fichier : ./src/app/components/trip-map/trip-map.component.html ======
<div class="w-full h-full bg-white rounded-lg shadow-lg">
    <div 
        style="height: 500px;" 
        leaflet 
        [leafletOptions]="options" 
        [leafletLayers]="layers"
        (leafletMapReady)="onMapReady($event)"
        class="rounded-lg"
    >
    </div>
</div>


====== Fichier : ./src/app/components/trip-map/trip-map.component.ts ======
import { Component, OnInit, Input, OnChanges, SimpleChanges } from '@angular/core';
import { CommonModule } from '@angular/common';
import { LeafletModule } from '@asymmetrik/ngx-leaflet';
import * as L from 'leaflet';
import { latLng, tileLayer, Map, Polyline, Layer } from 'leaflet';

// Interface pour les points de donn√©es de trajectoire
export interface GeoPoint {
  lat: number;
  lng: number;
  timestamp: number; // UNIX timestamp
}

@Component({
  selector: 'app-trip-map',
  standalone: true,
  imports: [CommonModule, LeafletModule],
  templateUrl: './trip-map.component.html',
  styleUrls: []
})
export class TripMapComponent implements OnChanges {
  // Entr√©e des coordonn√©es du trajet depuis le composant parent
  @Input() coordinates: GeoPoint[] = [];

  // Options Leaflet
  options = {
    layers: [
      // Couche de tuiles OpenStreetMap
      tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
        maxZoom: 18, 
        attribution: 'OpenStreetMap' 
      })
    ],
    zoom: 13,
    // Coordonn√©es initiales (Paris comme centre par d√©faut)
    center: latLng(48.8566, 2.3522)
  };

  layers: Layer[] = [];
  map!: Map;

  // Lorsque la carte est initialis√©e
  onMapReady(map: Map) {
    this.map = map;
    this.drawPath();
  }

  // Appel√© lorsque l'Input 'coordinates' change
  ngOnChanges(changes: SimpleChanges): void {
    if (changes['coordinates'] && this.map) {
      this.drawPath();
    }
  }

  private drawPath(): void {
    if (!this.coordinates || this.coordinates.length === 0) {
      this.layers = [];
      return;
    }

    // 1. Convertir les GeoPoints en objets LatLng pour Leaflet
    const latLngs = this.coordinates
      .map(p => L.latLng(p.lat, p.lng));

    // 2. Cr√©er la polyline (le trac√©)
    const polyline = new Polyline(latLngs as any, { 
      color: '#007bff', // Couleur du trac√© (bleu Bootstrap)
      weight: 5,
      opacity: 0.7 
    });

    // 3. Marqueur de d√©part
    const startMarker = L.marker(latLngs[0], {
      icon: L.icon({
        iconUrl: 'assets/marker-icon-start.png', // Chemin √† ajuster
        iconSize: [25, 41],
        iconAnchor: [12, 41]
      })
    }).bindPopup('D√©part du trajet');

    // 4. Marqueur d'arriv√©e
    const endMarker = L.marker(latLngs[latLngs.length - 1], {
      icon: L.icon({
        iconUrl: 'assets/marker-icon-end.png', // Chemin √† ajuster
        iconSize: [25, 41],
        iconAnchor: [12, 41]
      })
    }).bindPopup('Arriv√©e du trajet');


    // Mettre √† jour les calques de la carte
    this.layers = [polyline, startMarker, endMarker];

    // Ajuster le centre de la carte pour afficher l'ensemble du trac√©
    this.map.fitBounds(polyline.getBounds());
  }
}


====== Fichier : ./src/app/components/collaboration-list/collaboration-list.component.html ======
<div class="p-6">
  <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">
    Demandes de Collaboration Entrantes
  </h2>

  <div *ngIf="collaborationRequests | async as requests; else loading" class="space-y-4">
    <div *ngIf="requests.length === 0" class="p-6 text-center text-gray-600 bg-white rounded-lg shadow-md">
      <i class="fas fa-check-circle text-green-500 mr-2"></i>
      Aucune nouvelle demande de collaboration en attente.
    </div>

    <div *ngFor="let request of requests" class="bg-white p-5 rounded-lg shadow-xl border-l-4 border-blue-500 hover:shadow-2xl transition duration-300">
      <div class="flex justify-between items-start mb-3">
        <div>
          <p class="text-xl font-semibold text-gray-900">
            Colis {{ request.packageDetails.id }}
            <span class="text-sm font-normal text-gray-500 ml-2">
              {{ request.packageDetails.weight }} kg
            </span>
          </p>
          <p class="text-sm text-gray-600 mt-1">
            Demandeur:
            <span class="font-medium text-blue-700">{{ request.requesterCompanyId }}</span>
          </p>
        </div>
        <div class="text-right">
          <span class="text-2xl font-bold text-green-600">
            {{ request.proposedAmount | currency:'EUR':'symbol':'1.2-2' }}
          </span>
          <p class="text-xs text-gray-500">Montant propos√©</p>
        </div>
      </div>

      <div class="border-t border-gray-100 pt-3 mt-3 text-sm text-gray-700">
        <p>
          Trajet Cibl√© (Votre):
          <span class="font-medium text-purple-700">{{ request.targetTripId }}</span>
        </p>
        <p>Description: {{ request.packageDetails.description }}</p>
      </div>

      <div class="flex justify-end space-x-3 mt-4">
        <button
          (click)="declineRequest(request.id)"
          class="px-4 py-2 bg-red-100 text-red-700 font-semibold rounded-lg hover:bg-red-200 transition duration-150"
        >
          <i class="fas fa-times-circle mr-2"></i>
          D√©cliner
        </button>
        <button
          (click)="acceptRequest(request)"
          class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150"
        >
          <i class="fas fa-check-circle mr-2"></i>
          Accepter
        </button>
      </div>
    </div>
  </div>

  <ng-template #loading>
    <div class="p-6 text-center text-gray-500">
      Chargement des demandes en temps r√©el...
    </div>
  </ng-template>
</div>


====== Fichier : ./src/app/components/collaboration-list/collaboration-list.component.ts ======
import { Component, OnInit, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Observable } from 'rxjs';
import {
  Firestore,
  collection,
  collectionData,
  query,
  where,
  doc,
  updateDoc,
  writeBatch,
  Timestamp,
} from '@angular/fire/firestore';
import { CollaborationRequest } from '../../interfaces/collaboration-request.interface';

@Component({
  selector: 'app-collaboration-list',
  standalone: true,
  imports: [CommonModule],
  templateUrl: './collaboration-list.component.html',
})
export class CollaborationListComponent implements OnInit {
  private firestore = inject(Firestore);
  private readonly CURRENT_COMPANY_ID = 'AbC1dE2fG3hI4jK5lM6n';

  collaborationRequests!: Observable<CollaborationRequest[]>;

  ngOnInit(): void {
    this.collaborationRequests = this.getCollaborationRequests();
  }

  getCollaborationRequests(): Observable<CollaborationRequest[]> {
    const requestsCollection = collection(this.firestore, 'collaborationRequests');
    const q = query(
      requestsCollection,
      where('targetCompanyId', '==', this.CURRENT_COMPANY_ID),
      where('status', '==', 'pending')
    );
    return collectionData(q, { idField: 'id' }) as Observable<CollaborationRequest[]>;
  }

  async acceptRequest(request: CollaborationRequest): Promise<void> {
    if (!confirm(`Accepter la collaboration pour le colis ${request.packageDetails.id} ?`)) {
      return;
    }

    const batch = writeBatch(this.firestore);

    // 1. Mise √† jour du statut dans collaborationRequests
    const requestDocRef = doc(this.firestore, 'collaborationRequests', request.id);
    batch.update(requestDocRef, {
      status: 'accepted',
      acceptedAt: Timestamp.now(),
    });

    // 2. Cr√©ation d'une r√©f√©rence crois√©e pour le suivi du colis
    const shipmentTrackingRef = doc(
      this.firestore,
      'shipmentTracking',
      request.packageDetails.id
    );
    batch.set(
      shipmentTrackingRef,
      {
        packageId: request.packageDetails.id,
        status: 'COLLABORATION_ACCEPTED',
        originalCompanyId: request.requesterCompanyId,
        deliveryCompanyId: this.CURRENT_COMPANY_ID,
        assignedTripId: request.targetTripId,
        acceptedAmount: request.proposedAmount,
        lastUpdated: Timestamp.now(),
      },
      { merge: true }
    );

    try {
      await batch.commit();
      alert('Demande accept√©e et suivi du colis mis √† jour !');
    } catch (error: any) {
      console.error('Erreur lors de l\'acceptation de la demande (Batch failed)', error);
      alert('Erreur lors de l\'acceptation.');
    }
  }

  async declineRequest(requestId: string): Promise<void> {
    if (!confirm('D√©cliner cette demande de collaboration ?')) {
      return;
    }

    const requestDocRef = doc(this.firestore, 'collaborationRequests', requestId);
    try {
      await updateDoc(requestDocRef, {
        status: 'rejected',
        rejectedAt: Timestamp.now(),
      });
      alert('Demande d√©clin√©e.');
    } catch (error: any) {
      console.error('Erreur lors du d√©clin de la demande', error);
    }
  }
}


====== Fichier : ./src/app/components/city-select/city-select.component.html ======
<div class="relative">
  <label class="block text-sm font-medium text-gray-700 mb-1">
    {{ icon }} {{ label }}
  </label>
  
  <input
    type="text"
    [value]="value"
    (input)="onInputChange($any($event.target).value)"
    (focus)="showDropdown = true"
    (blur)="closeDropdown()"
    [placeholder]="placeholder"
    [disabled]="disabled"
    class="w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100"
    autocomplete="off"
  />

  <!-- Dropdown -->
  <div
    *ngIf="showDropdown && filteredCities.length > 0"
    class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"
  >
    <div
      *ngFor="let city of filteredCities"
      (click)="selectCity(city)"
      class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm transition"
      [class.bg-blue-100]="city === value"
    >
      {{ city }}
    </div>
  </div>

  <!-- Message si aucune ville -->
  <div
    *ngIf="showDropdown && filteredCities.length === 0"
    class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg p-3 text-center text-gray-500 text-sm"
  >
    Aucune ville trouv√©e
  </div>
</div>


====== Fichier : ./src/app/components/city-select/city-select.component.ts ======
import { Component, Input, forwardRef, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ControlValueAccessor, NG_VALUE_ACCESSOR } from '@angular/forms';
import { TUNISIA_CITIES } from '../../data/tunisia-cities';

@Component({
  selector: 'app-city-select',
  standalone: true,
  imports: [CommonModule],
  template: `
    <div class="relative">
      <label *ngIf="label" class="block text-sm font-medium text-gray-700 mb-1">
        {{ icon }} {{ label }}
        <span *ngIf="required" class="text-red-500">*</span>
      </label>
      
      <input
        type="text"
        [value]="value"
        (input)="onInput($event)"
        (focus)="onFocus()"
        (blur)="onBlur()"
        [placeholder]="placeholder"
        [disabled]="disabled"
        class="w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100 disabled:cursor-not-allowed"
        autocomplete="off"
      />

      <!-- Dropdown avec r√©sultats -->
      <div
        *ngIf="showDropdown && filteredCities.length > 0"
        class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto"
      >
        <div
          *ngFor="let city of filteredCities"
          (mousedown)="selectCity(city)"
          class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm transition-colors"
          [class.bg-blue-100]="city === value"
        >
          {{ city }}
        </div>
      </div>

      <!-- Message aucun r√©sultat -->
      <div
        *ngIf="showDropdown && filteredCities.length === 0 && value"
        class="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg p-3 text-center text-gray-500 text-sm"
      >
        Aucune ville trouv√©e pour "{{ value }}"
      </div>
    </div>
  `,
  providers: [
    {
      provide: NG_VALUE_ACCESSOR,
      useExisting: forwardRef(() => CitySelectComponent),
      multi: true,
    },
  ],
})
export class CitySelectComponent implements ControlValueAccessor, OnInit {
  @Input() label = '';
  @Input() placeholder = 'Rechercher une ville...';
  @Input() icon = 'üèôÔ∏è';
  @Input() required = false;

  value = '';
  allCities = TUNISIA_CITIES;
  filteredCities: string[] = [];
  showDropdown = false;
  disabled = false;

  private onChange: (value: string) => void = () => {};
  private onTouched: () => void = () => {};

  ngOnInit(): void {
    this.filteredCities = this.allCities;
  }

  onInput(event: Event): void {
    const input = event.target as HTMLInputElement;
    this.value = input.value;
    this.filterCities(this.value);
    this.onChange(this.value);
  }

  onFocus(): void {
    this.showDropdown = true;
    this.filterCities(this.value);
  }

  onBlur(): void {
    // D√©lai pour permettre le clic sur un √©l√©ment
    setTimeout(() => {
      this.showDropdown = false;
      this.onTouched();
    }, 200);
  }

  filterCities(searchText: string): void {
    if (!searchText || searchText.trim() === '') {
      this.filteredCities = this.allCities;
      return;
    }

    const search = searchText.toLowerCase().trim();
    this.filteredCities = this.allCities.filter((city) =>
      city.toLowerCase().includes(search)
    );
  }

  selectCity(city: string): void {
    this.value = city;
    this.onChange(city);
    this.showDropdown = false;
  }

  // ControlValueAccessor
  writeValue(value: string): void {
    this.value = value || '';
    this.filterCities(this.value);
  }

  registerOnChange(fn: (value: string) => void): void {
    this.onChange = fn;
  }

  registerOnTouched(fn: () => void): void {
    this.onTouched = fn;
  }

  setDisabledState(isDisabled: boolean): void {
    this.disabled = isDisabled;
  }
}


====== Fichier : ./src/app/components/header/header.component.html ======
<ng-container *ngIf="user$ | async as user">
  <header class="bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        
        <!-- Logo -->
        <div class="flex items-center">
          <div class="flex-shrink-0 flex items-center gap-2 cursor-pointer" routerLink="/collaborations/demandes">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">C</div>
            <span class="hidden md:block text-xl font-bold text-blue-900">ColisShare</span>
          </div>
          
          <!-- MENU DESKTOP (√âcran large) -->
          <nav class="hidden md:ml-8 md:flex md:space-x-6">
            <a routerLink="/collaborations/demandes" 
               routerLinkActive="text-blue-600 border-b-2 border-blue-600" 
               class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
               ü§ù Collabs
            </a>
            
            <a routerLink="/trajets/saisie" 
               routerLinkActive="text-blue-600 border-b-2 border-blue-600" 
               class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
               ‚ûï Trajet+
            </a>

            <a routerLink="/trajets/historique" 
               routerLinkActive="text-blue-600 border-b-2 border-blue-600" 
               class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
               üìã Historique
            </a>

            <a routerLink="/voitures" 
               routerLinkActive="text-blue-600 border-b-2 border-blue-600" 
               class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
               üöó Gestion Voitures
            </a>
          </nav>
        </div>

        <!-- Actions Droite (Profil + Logout + Chat Desktop) -->
        <div class="flex items-center gap-2 md:gap-4">
          
          <!-- Chat Icon (Visible Desktop) -->
          <a routerLink="/chat" routerLinkActive="text-blue-600 bg-blue-50" class="hidden md:flex p-2 rounded-full text-gray-400 hover:text-blue-600 hover:bg-gray-50 transition-all relative group">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
            </svg>
            <span class="hidden group-hover:block absolute top-10 right-0 bg-gray-800 text-white text-xs px-2 py-1 rounded shadow-lg">Chat</span>
          </a>

          <!-- User Info -->
          <div class="flex items-center gap-3 pl-2 md:pl-4 md:border-l border-gray-200">
            <div class="hidden lg:flex flex-col items-end">
              <span class="text-sm font-semibold text-gray-900">{{ user.displayName }}</span>
              <span class="text-xs text-gray-500 truncate max-w-[120px]">{{ user.email }}</span>
            </div>
            
            <div class="h-8 w-8 md:h-9 md:w-9 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-bold border border-blue-200 text-sm">
              {{ user.displayName?.charAt(0)?.toUpperCase() || 'U' }}
            </div>

            <button (click)="logout()" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-all" title="D√©connexion">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 md:w-6 md:h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0 3 3m-3-3h12.75" />
              </svg>
            </button>
          </div>
        </div>

      </div>
      
      <!-- MENU MOBILE (Barre du bas visible uniquement sur petits √©crans) -->
      <div class="md:hidden py-2 border-t border-gray-100 grid grid-cols-5 gap-1 text-center text-[10px] sm:text-xs font-medium text-gray-500">
        
        <a routerLink="/collaborations/demandes" routerLinkActive="text-blue-600 bg-blue-50 rounded-lg" class="flex flex-col items-center p-2 gap-1">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
          Collabs
        </a>

        <a routerLink="/trajets/saisie" routerLinkActive="text-blue-600 bg-blue-50 rounded-lg" class="flex flex-col items-center p-2 gap-1">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          Trajet+
        </a>

        <!-- Gestion Voitures -->
        <a routerLink="/voitures" routerLinkActive="text-blue-600 bg-blue-50 rounded-lg" class="flex flex-col items-center p-2 gap-1">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
          Autos
        </a>

        <a routerLink="/trajets/historique" routerLinkActive="text-blue-600 bg-blue-50 rounded-lg" class="flex flex-col items-center p-2 gap-1">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
          Histo
        </a>

        <a routerLink="/chat" routerLinkActive="text-blue-600 bg-blue-50 rounded-lg" class="flex flex-col items-center p-2 gap-1">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
          Chat
        </a>

      </div>
    </div>
  </header>
</ng-container>


====== Fichier : ./src/app/components/header/header.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router, RouterModule } from '@angular/router';
import { AuthService } from '../../services/auth.service';
import { Observable } from 'rxjs';
import { User } from '@angular/fire/auth';

@Component({
  selector: 'app-header',
  standalone: true,
  imports: [CommonModule, RouterModule],
  templateUrl: './header.component.html',
})
export class HeaderComponent {
  private auth = inject(AuthService);
  private router = inject(Router);

  // Observable qui vaut 'null' si pas connect√©
  user$: Observable<User | null> = this.auth.user$;

  async logout() {
    try {
      await this.auth.logout();
      this.router.navigate(['/']);
    } catch (error) {
      console.error('Erreur d√©connexion:', error);
    }
  }
}


====== Fichier : ./src/app/app.config.ts ======
import { ApplicationConfig, importProvidersFrom } from '@angular/core';
import { provideRouter } from '@angular/router';
import { routes } from './app.routes';
import { initializeApp, provideFirebaseApp } from '@angular/fire/app';
import { getAuth, provideAuth } from '@angular/fire/auth';
import { getFirestore, provideFirestore } from '@angular/fire/firestore';
import { environment } from '../environments/environment';

export const appConfig: ApplicationConfig = {
  providers: [
    provideRouter(routes),
    // Initialisation de Firebase
    provideFirebaseApp(() => initializeApp(environment.firebaseConfig)),
    // Auth Provider (Corrige l'erreur NG0201)
    provideAuth(() => getAuth()),
    // Firestore Provider
    provideFirestore(() => getFirestore())
  ]
};


====== Fichier : ./src/app/app.component.css ======
/* Styles optionnels pour le menu */


====== Fichier : ./src/app/app.html ======
<router-outlet />


====== Fichier : ./src/app/data/tunisia-cities.ts ======
export const TUNISIA_CITIES = [
  'Tunis',
  'Ariana',
  'Ben Arous',
  'Manouba',
  'Nabeul',
  'Zaghouan',
  'Bizerte',
  'B√©ja',
  'Jendouba',
  'Kef',
  'Siliana',
  'Sousse',
  'Monastir',
  'Mahdia',
  'Sfax',
  'Kairouan',
  'Kasserine',
  'Sidi Bouzid',
  'Gab√®s',
  'M√©denine',
  'Tataouine',
  'Gafsa',
  'Tozeur',
  'K√©bili',
  'Hammamet',
  'Korba',
  'Grombalia',
  'Menzel Bourguiba',
  'Mateur',
  'Sejnane',
  'Testour',
  'Medjez el-Bab',
  'Tabarka',
  'Ain Draham',
  'Ghardimaou',
  'Dahmani',
  'Maktar',
  'Rouhia',
  'Kalaa Kebira',
  'Kalaa Sghira',
  'Msaken',
  'Moknine',
  'Jammal',
  'Ksar Hellal',
  'Sahline',
  'Bekalta',
  'Teboulba',
  'Ouardenine',
  'Chebba',
  'Ksour Essef',
  'El Jem',
  'Agareb',
  'Sakiet Ezzit',
  'Sakiet Eddaier',
  'Kerkennah',
  'Sbeitla',
  'Feriana',
  'Foussana',
  'Thala',
  'Metlaoui',
  'Redeyef',
  'Mdhilla',
  'Nefta',
  'Degache',
  'Douz',
  'Souk Lahad',
  'El Faouar',
  'Mareth',
  'Zarzis',
  'Djerba',
  'Houmt Souk',
  'Midoun',
  'Ajim',
  'Remada',
  'Ghomrassen',
  'Ben Guerdane',
].sort();


====== Fichier : ./src/app/pages/home/home-page.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms'; // Import essentiel pour ngModel
import { Router, RouterModule } from '@angular/router';
import { AuthService } from '../../services/auth.service';

@Component({
  selector: 'app-home-page',
  standalone: true,
  imports: [CommonModule, RouterModule, FormsModule], // Ajout de FormsModule ici
  templateUrl: './home-page.component.html',
})
export class HomePageComponent {
  private auth = inject(AuthService);
  private router = inject(Router);

  // Propri√©t√©s li√©es au formulaire (ngModel)
  email = '';
  password = '';
  displayName = '';
  
  // √âtat de l'interface
  isLoginMode = true;
  isLoading = false;
  errorMessage = '';

  toggleMode() {
    this.isLoginMode = !this.isLoginMode;
    this.errorMessage = '';
  }

  async onSubmit() {
    if (this.isLoading) return;
    this.isLoading = true;
    this.errorMessage = '';

    try {
      if (this.isLoginMode) {
        await this.auth.login(this.email, this.password).toPromise();
      } else {
        await this.auth.signUp(this.email, this.password, this.displayName).toPromise();
      }
      // Redirection apr√®s succ√®s
      this.router.navigate(['/collaborations/demandes']);
    } catch (err: any) {
      console.error(err);
      this.errorMessage = this.getErrorMessage(err);
    } finally {
      this.isLoading = false;
    }
  }

  async loginGoogle() {
    try {
      await this.auth.loginWithGoogle().toPromise();
      this.router.navigate(['/collaborations/demandes']);
    } catch (err: any) {
      console.error(err);
      this.errorMessage = "Erreur avec Google : " + err.message;
    }
  }

  private getErrorMessage(err: any): string {
    // Traduction basique des erreurs Firebase
    const msg = err.message || '';
    if (msg.includes('auth/invalid-email')) return 'Email invalide.';
    if (msg.includes('auth/user-not-found')) return 'Utilisateur inconnu.';
    if (msg.includes('auth/wrong-password')) return 'Mot de passe incorrect.';
    if (msg.includes('auth/email-already-in-use')) return 'Cet email est d√©j√† utilis√©.';
    return 'Une erreur est survenue. V√©rifiez vos identifiants.';
  }
}


====== Fichier : ./src/app/pages/home/home-page.component.ts.bak ======
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterLink, RouterLinkActive } from '@angular/router';

interface HomeSlide {
  title: string;
  subtitle: string;
  description: string;
  tag: string;
}

@Component({
  standalone: true,
  selector: 'app-home-page',
  templateUrl: './home-page.component.html',
  imports: [CommonModule, RouterLink, RouterLinkActive],
})
export class HomePageComponent {
  slides: HomeSlide[] = [
    {
      title: 'Bienvenue sur Transport Collab',
      subtitle: 'Optimisez vos trajets, partagez vos capacit√©s.',
      description:
        'Cette application vous aide √† g√©rer vos v√©hicules, planifier vos trajets et collaborer avec d'autres transporteurs pour rentabiliser chaque kilom√®tre.',
      tag: 'Pr√©sentation',
    },
    {
      title: 'Gestion des voitures',
      subtitle: 'Centralisez votre flotte.',
      description:
        'Ajoutez, modifiez et d√©sactivez vos v√©hicules. Visualisez rapidement leur capacit√© et leur disponibilit√© pour les prochains trajets.',
      tag: 'Flotte',
    },
    {
      title: 'Saisie & Historique des trajets',
      subtitle: 'Suivez vos op√©rations.',
      description:
        'D√©clarez facilement un nouveau trajet et gardez un historique clair des trajets pass√©s, en cours ou planifi√©s.',
      tag: 'Trajets',
    },
    {
      title: 'Demandes de collaboration',
      subtitle: 'Partagez vos capacit√©s avec d'autres.',
      description:
        'Recevez et g√©rez les demandes de collab sur vos trajets : acceptez, refusez et n√©gociez pour optimiser vos tourn√©es.',
      tag: 'Collaboration',
    },
    {
      title: 'Chat temps r√©el',
      subtitle: 'Communiquez sans friction.',
      description:
        'Discutez avec vos partenaires directement depuis l'application pour r√©gler les d√©tails d'un trajet ou d'un colis en quelques messages.',
      tag: 'Communication',
    },
  ];

  activeIndex = 0;

  nextSlide(): void {
    this.activeIndex = (this.activeIndex + 1) % this.slides.length;
  }

  prevSlide(): void {
    this.activeIndex =
      (this.activeIndex - 1 + this.slides.length) % this.slides.length;
  }

  goToSlide(index: number): void {
    this.activeIndex = index;
  }
}


====== Fichier : ./src/app/pages/home/home-page.component.html ======
<!-- Pas de Header ici car c'est la page publique -->

<div class="min-h-screen flex flex-col md:flex-row bg-white">
  
  <!-- Partie Gauche : Visuel (Cach√© sur mobile) -->
  <div class="hidden md:flex md:w-1/2 bg-blue-600 items-center justify-center p-12 text-white relative overflow-hidden">
    <div class="absolute inset-0 bg-gradient-to-br from-blue-600 to-indigo-900 opacity-90"></div>
    <div class="relative z-10 max-w-md">
      <h1 class="text-5xl font-bold mb-6">ColisShare</h1>
      <p class="text-xl text-blue-100 mb-8">
        La solution intelligente pour rentabiliser vos trajets et collaborer avec d'autres transporteurs.
      </p>
      <div class="flex gap-4 text-sm font-medium">
        <div class="bg-white/10 px-4 py-2 rounded-lg backdrop-blur-sm">üöÄ Gestion Flotte</div>
        <div class="bg-white/10 px-4 py-2 rounded-lg backdrop-blur-sm">ü§ù Collaboration</div>
        <div class="bg-white/10 px-4 py-2 rounded-lg backdrop-blur-sm">üìç Suivi GPS</div>
      </div>
    </div>
    <!-- Cercles d√©coratifs -->
    <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
    <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-400/20 rounded-full blur-3xl"></div>
  </div>

  <!-- Partie Droite : Formulaire Login/Signup -->
  <div class="flex-1 flex items-center justify-center p-6 sm:p-12 bg-gray-50">
    <div class="w-full max-w-md space-y-8 bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
      
      <!-- En-t√™te Mobile (Logo) -->
      <div class="md:hidden text-center mb-8">
        <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-blue-600 text-white font-bold text-2xl mb-2">C</div>
        <h2 class="text-2xl font-bold text-gray-900">ColisShare</h2>
      </div>

      <div class="text-center">
        <h2 class="text-3xl font-bold tracking-tight text-gray-900">
          {{ isLoginMode ? 'Bon retour !' : 'Cr√©er un compte' }}
        </h2>
        <p class="mt-2 text-sm text-gray-600">
          {{ isLoginMode ? 'Connectez-vous pour g√©rer vos trajets.' : 'Rejoignez la communaut√© des transporteurs.' }}
        </p>
      </div>

      <!-- Le Formulaire -->
      <form (ngSubmit)="onSubmit()" class="mt-8 space-y-6">
        <div class="space-y-4">
          <div *ngIf="!isLoginMode">
            <label for="name" class="sr-only">Nom complet</label>
            <input id="name" name="displayName" type="text" required 
              [(ngModel)]="displayName"
              class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 shadow-sm" 
              placeholder="Nom complet">
          </div>
          <div>
            <label for="email-address" class="sr-only">Adresse Email</label>
            <input id="email-address" name="email" type="email" autocomplete="email" required 
              [(ngModel)]="email"
              class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 shadow-sm" 
              placeholder="Adresse email">
          </div>
          <div>
            <label for="password" class="sr-only">Mot de passe</label>
            <input id="password" name="password" type="password" autocomplete="current-password" required 
              [(ngModel)]="password"
              class="relative block w-full rounded-lg border-0 py-3 px-4 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:z-10 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 shadow-sm" 
              placeholder="Mot de passe">
          </div>
        </div>

        <div *ngIf="errorMessage" class="text-red-500 text-sm text-center bg-red-50 p-2 rounded border border-red-100">
          {{ errorMessage }}
        </div>

        <div>
          <button type="submit" 
            [disabled]="isLoading"
            class="group relative flex w-full justify-center rounded-lg bg-blue-600 py-3 px-4 text-sm font-semibold text-white hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600 disabled:opacity-70 transition-all shadow-md hover:shadow-lg">
            <span *ngIf="isLoading" class="absolute inset-y-0 left-0 flex items-center pl-3">
              <!-- CORRECTION SVG STRICTE : Utilisation de la fermeture automatique /> et suppression des balises fermantes explicites -->
              <svg class="h-5 w-5 animate-spin text-white" viewBox="0 0 24 24">
                ircle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" />
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
            </span>
            {{ isLoginMode ? 'Se connecter' : "S'inscrire" }}
          </button>
        </div>

        <div class="relative">
          <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
          <div class="relative flex justify-center text-sm"><span class="bg-white px-2 text-gray-500">Ou continuer avec</span></div>
        </div>

        <button type="button" (click)="loginGoogle()" 
          class="flex w-full items-center justify-center gap-3 rounded-lg bg-white px-3 py-3 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 transition-all">
          <img src="https://www.svgrepo.com/show/475656/google-color.svg" alt="Google" class="h-5 w-5">
          <span>Google</span>
        </button>
      </form>

      <div class="text-center mt-6">
        <p class="text-sm text-gray-600">
          {{ isLoginMode ? "Pas encore de compte ?" : "D√©j√† inscrit ?" }}
          <button (click)="toggleMode()" class="font-semibold text-blue-600 hover:text-blue-500 transition-colors">
            {{ isLoginMode ? "Cr√©er un compte" : "Se connecter" }}
          </button>
        </p>
      </div>

    </div>
  </div>
</div>


====== Fichier : ./src/app/pages/auth/login-page.component.html ======
<div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 space-y-4">
    <h1 class="text-2xl font-bold text-gray-800 text-center">Connexion</h1>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input type="email" formControlName="email" class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
        <input type="password" formControlName="password" class="w-full border rounded px-3 py-2">
      </div>

      <button type="submit" [disabled]="loading" class="w-full bg-blue-600 text-white py-2 rounded mt-2">
        <span *ngIf="!loading">Se connecter</span>
        <span *ngIf="loading">Connexion...</span>
      </button>
    </form>

    <button (click)="loginWithGoogle()" [disabled]="loading" class="w-full border border-gray-300 py-2 rounded flex items-center justify-center gap-2">
      <span>üîê</span>
      <span>Continuer avec Google</span>
    </button>

    <p *ngIf="errorMessage" class="text-red-600 text-sm text-center">{{ errorMessage }}</p>

    <p class="text-center text-sm text-gray-600">
      Pas de compte ?
      <a routerLink="/signup" class="text-blue-600 underline">Cr√©er un compte</a>
    </p>
  </div>
</div>


====== Fichier : ./src/app/pages/auth/login-page.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormBuilder, Validators } from '@angular/forms';
import { RouterModule } from '@angular/router';
import { AuthService } from '../../services/auth.service';

@Component({
  selector: 'app-login-page',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterModule],
  templateUrl: './login-page.component.html',
})
export class LoginPageComponent {
  private fb = inject(FormBuilder);
  private auth = inject(AuthService);

  loading = false;
  errorMessage = '';

  form = this.fb.group({
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required]],
  });

  async onSubmit(): Promise<void> {
    if (this.form.invalid) return;
    this.loading = true;
    this.errorMessage = '';
    try {
      const { email, password } = this.form.value;
      await this.auth.login(email!, password!);
    } catch (e: any) {
      this.errorMessage = e.message || 'Erreur de connexion';
    } finally {
      this.loading = false;
    }
  }

  async loginWithGoogle(): Promise<void> {
    this.loading = true;
    this.errorMessage = '';
    try {
      await this.auth.loginWithGoogle();
    } catch (e: any) {
      this.errorMessage = e.message || 'Erreur Google';
    } finally {
      this.loading = false;
    }
  }
}


====== Fichier : ./src/app/pages/auth/signup-page.component.html ======
<div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
  <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 space-y-4">
    <h1 class="text-2xl font-bold text-gray-800 text-center">Cr√©er un compte</h1>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nom complet</label>
        <input type="text" formControlName="displayName" class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input type="email" formControlName="email" class="w-full border rounded px-3 py-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
        <input type="password" formControlName="password" class="w-full border rounded px-3 py-2">
      </div>

      <button type="submit" [disabled]="loading" class="w-full bg-green-600 text-white py-2 rounded mt-2">
        <span *ngIf="!loading">Cr√©er le compte</span>
        <span *ngIf="loading">Cr√©ation...</span>
      </button>
    </form>

    <p *ngIf="errorMessage" class="text-red-600 text-sm text-center">{{ errorMessage }}</p>

    <p class="text-center text-sm text-gray-600">
      D√©j√† un compte ?
      <a routerLink="/login" class="text-blue-600 underline">Se connecter</a>
    </p>
  </div>
</div>


====== Fichier : ./src/app/pages/auth/signup-page.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule, FormBuilder, Validators } from '@angular/forms';
import { RouterModule } from '@angular/router';
import { AuthService } from '../../services/auth.service';

@Component({
  selector: 'app-signup-page',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, RouterModule],
  templateUrl: './signup-page.component.html',
})
export class SignupPageComponent {
  private fb = inject(FormBuilder);
  private auth = inject(AuthService);

  loading = false;
  errorMessage = '';

  form = this.fb.group({
    displayName: ['', [Validators.required]],
    email: ['', [Validators.required, Validators.email]],
    password: ['', [Validators.required, Validators.minLength(6)]],
  });

  async onSubmit(): Promise<void> {
    if (this.form.invalid) return;
    this.loading = true;
    this.errorMessage = '';
    try {
      const { displayName, email, password } = this.form.value;
      await this.auth.signUp(email!, password!, displayName!);
    } catch (e: any) {
      this.errorMessage = e.message || 'Erreur inscription';
    } finally {
      this.loading = false;
    }
  }
}


====== Fichier : ./src/app/pages/collaborations/collab-requests-page.component.html ======
<app-header></app-header>

<div class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto">
    
    <!-- DEBUG BAR -->
    <div class="bg-yellow-100 p-2 text-xs font-mono mb-4 text-yellow-800 rounded border border-yellow-200" *ngIf="currentUser$ | async as user">
      DEBUG: Mon ID = {{ user.uid }}
    </div>

    <!-- En-t√™te -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-6">Collaborations</h1>
      
      <!-- Onglets -->
      <div class="flex space-x-4 border-b border-gray-200 overflow-x-auto">
        <button (click)="setActiveTab('search')" 
                [class]="activeTab === 'search' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                class="pb-3 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
          üîç Rechercher
        </button>
        
        <button (click)="setActiveTab('pending')" 
                class="relative pb-3 px-1 border-b-2 font-medium text-sm whitespace-nowrap"
                [class]="activeTab === 'pending' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
          üîî Demandes re√ßues
          <ng-container *ngIf="pendingRequests$ | async as pending">
            <span *ngIf="pending.length > 0" class="ml-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">
              {{ pending.length }}
            </span>
          </ng-container>
        </button>

        <button (click)="setActiveTab('accepted')" 
                [class]="activeTab === 'accepted' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                class="pb-3 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
          ‚úÖ Mes Collaborateurs
        </button>
      </div>
    </div>

    <!-- 1. Onglet RECHERCHE -->
    <div *ngIf="activeTab === 'search'" class="animate-fade-in">
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <ng-container *ngIf="allUsers$ | async as users">
          <div *ngFor="let user of users" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-lg">
                {{ (user.displayName && user.displayName.length > 0) ? user.displayName.charAt(0).toUpperCase() : 'U' }}
              </div>
              <div class="overflow-hidden">
                <h3 class="font-bold text-gray-900 truncate">{{ user.displayName || 'Utilisateur' }}</h3>
                <p class="text-xs text-gray-500 truncate">{{ user.email }}</p>
                <p class="text-[10px] text-gray-300 truncate font-mono mt-1">{{ user.uid }}</p>
              </div>
            </div>
            
            <ng-container *ngIf="currentUser$ | async as currentUser">
              <button *ngIf="user.uid !== currentUser.uid"
                      (click)="sendRequest(user.uid, currentUser.uid)"
                      class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium shadow-sm">
                Envoyer demande
              </button>
              <div *ngIf="user.uid === currentUser.uid" class="text-center text-xs text-gray-400 italic mt-2">
                (C'est vous)
              </div>
            </ng-container>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- 2. Onglet DEMANDES RE√áUES (Pending) -->
    <div *ngIf="activeTab === 'pending'" class="animate-fade-in">
      <ng-container *ngIf="pendingRequests$ | async as requests">
        
        <div *ngIf="requests.length === 0" class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
          <p class="text-gray-500">Aucune demande en attente.</p>
          <p class="text-xs text-gray-400 mt-2">(V√©rifiez la console pour le debug)</p>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div *ngFor="let req of requests" class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-yellow-400 flex flex-col gap-3">
            <div class="flex justify-between items-start">
              <div>
                <p class="text-sm text-gray-500 font-medium">Demande re√ßue</p>
                <p class="text-xs text-gray-400 font-mono mt-1">De : {{ req.fromUserId }}</p>
                <p class="text-xs text-gray-400">Statut: <span class="font-bold">{{ req.status }}</span></p>
              </div>
              <div class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">En attente</div>
            </div>
            
            <div class="flex gap-2 mt-2 pt-3 border-t border-gray-100">
              <button (click)="accept(req)" class="flex-1 px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition shadow-sm">
                Accepter
              </button>
              <button (click)="decline(req)" class="flex-1 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-semibold hover:bg-gray-50 transition">
                Refuser
              </button>
            </div>
          </div>
        </div>

      </ng-container>
    </div>

    <!-- 3. Onglet COLLABORATIONS ACCEPT√âES -->
    <div *ngIf="activeTab === 'accepted'" class="animate-fade-in">
      <ng-container *ngIf="acceptedCollaborations$ | async as collabs">
        <div *ngIf="collabs.length === 0" class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
          <p class="text-gray-500">Vous n'avez pas encore de collaborateurs.</p>
        </div>
        <!-- ... Reste inchang√© ... -->
        <div class="grid gap-4 md:grid-cols-2">
          <div *ngFor="let collab of collabs" class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center group">
             <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
                  <span class="font-bold text-gray-800">Actif</span>
                </div>
                <p class="text-xs text-gray-400">ID: {{ collab.id | slice:0:8 }}...</p>
             </div>
             <button (click)="deleteCollab(collab)" class="text-red-500 text-sm hover:underline">Rompre</button>
          </div>
        </div>
      </ng-container>
    </div>

  </div>
</div>


====== Fichier : ./src/app/pages/collaborations/collab-requests-page.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { AuthService } from '../../services/auth.service';
import { CollaborationService, CollaborationRequest } from '../../services/collaboration.service';
import { HeaderComponent } from '../../components/header/header.component';
import { switchMap, of } from 'rxjs';

@Component({
  selector: 'app-collab-requests-page',
  standalone: true,
  imports: [CommonModule, RouterModule, HeaderComponent],
  templateUrl: './collab-requests-page.component.html',
})
export class CollaborationRequestsPageComponent {
  private auth = inject(AuthService);
  private collab = inject(CollaborationService);

  currentUser$ = this.auth.user$;
  activeTab: 'search' | 'pending' | 'accepted' = 'search';

  // Variables utilis√©es dans le HTML
  allUsers$ = this.collab.getAllUsers();
  
  pendingRequests$ = this.currentUser$.pipe(
    switchMap(user => user ? this.collab.getPendingRequestsForUser(user.uid) : of([]))
  );

  acceptedCollaborations$ = this.currentUser$.pipe(
    switchMap(user => user ? this.collab.getAcceptedCollaborations(user.uid) : of([]))
  );

  // Actions
  async sendRequest(targetId: string, currentUserId: string) {
    try {
      await this.collab.sendRequest(currentUserId, targetId);
      alert('‚úÖ Demande envoy√©e !');
    } catch (err: any) {
      alert('‚ùå ' + err.message);
    }
  }

  async accept(c: CollaborationRequest) {
    if (!c.id) return;
    try {
      await this.collab.updateRequestStatus(c.id, 'accepted');
    } catch(e) { console.error(e); }
  }

  // Nomm√© 'decline' ici, il faut utiliser 'decline' dans le HTML (pas reject)
  async decline(c: CollaborationRequest) {
    if (!c.id) return;
    if (confirm('Refuser cette demande ?')) {
      await this.collab.updateRequestStatus(c.id, 'rejected');
    }
  }

  async deleteCollab(c: CollaborationRequest) {
    if (!c.id) return;
    if (confirm('Supprimer cette collaboration ?')) {
      await this.collab.deleteCollaboration(c.id);
    }
  }

  setActiveTab(tab: 'search' | 'pending' | 'accepted') {
    this.activeTab = tab;
  }
}


====== Fichier : ./src/app/pages/trips-history/trips-history-page.component.ts.bak ======
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Router } from '@angular/router';
import { FormsModule } from '@angular/forms';
import {
  FormBuilder,
  FormGroup,
  Validators,
  ReactiveFormsModule,
} from '@angular/forms';
import { Observable, map } from 'rxjs';
import { Timestamp } from '@angular/fire/firestore';
import { FirestoreService } from '../../services/firestore.service';
import { Trip, TripStatus } from '../../interfaces/trip.interface';
import { Car } from '../../interfaces/car.interface';

interface TripWithCar extends Trip {
  car?: Car;
}

@Component({
  selector: 'app-trips-history-page',
  standalone: true,
  imports: [CommonModule, ReactiveFormsModule, FormsModule],
  templateUrl: './trips-history-page.component.html',
})
export class TripsHistoryPageComponent implements OnInit {
  private readonly COMPANY_ID = 'AbC1dE2fG3hI4jK5lM6n';

  trips$!: Observable<TripWithCar[]>;
  filteredTrips: TripWithCar[] = [];
  availableCars$!: Observable<Car[]>;
  availableCars: Car[] = [];
  
  searchText = '';
  filterStatus: TripStatus | 'all' = 'all';
  sortField: 'departureCity' | 'estimatedDepartureTime' | 'status' = 'estimatedDepartureTime';
  sortDirection: 'asc' | 'desc' = 'desc';
  
  showEditModal = false;
  editForm!: FormGroup;
  selectedTrip: Trip | null = null;
  
  showDetailsModal = false;
  detailsTrip: TripWithCar | null = null;
  
  loading = false;
  selectedTrips = new Set<string>();
  selectAll = false;

  statusLabels: Record<TripStatus, string> = {
    pending: 'En attente',
    in_progress: 'En cours',
    completed: 'Termin√©',
    cancelled: 'Annul√©',
  };

  statusColors: Record<TripStatus, string> = {
    pending: 'bg-yellow-100 text-yellow-800 border-yellow-300',
    in_progress: 'bg-blue-100 text-blue-800 border-blue-300',
    completed: 'bg-green-100 text-green-800 border-green-300',
    cancelled: 'bg-red-100 text-red-800 border-red-300',
  };

  constructor(
    private fb: FormBuilder,
    private firestoreService: FirestoreService,
    private router: Router
  ) {}

  ngOnInit(): void {
    this.loadCars();
    this.loadTrips();
    this.initEditForm();
  }

  loadCars(): void {
    this.availableCars$ = this.firestoreService.getCars(this.COMPANY_ID);
    this.availableCars$.subscribe(cars => {
      this.availableCars = cars;
    });
  }

  loadTrips(): void {
    this.trips$ = this.firestoreService.getTrips(this.COMPANY_ID).pipe(
      map(trips => {
        const tripsWithCar = trips.map(trip => ({
          ...trip,
          car: this.availableCars.find(car => car.id === trip.carId)
        }));
        this.filteredTrips = this.applyFilters(tripsWithCar);
        return this.filteredTrips;
      })
    );
  }

  applyFilters(trips: TripWithCar[]): TripWithCar[] {
    return trips.filter(trip => {
      if (this.searchText) {
        const search = this.searchText.toLowerCase();
        const matchCity = trip.departureCity.toLowerCase().includes(search) ||
                         trip.arrivalCity.toLowerCase().includes(search);
        const matchCar = trip.car?.licensePlate?.toLowerCase().includes(search) ||
                        trip.car?.make?.toLowerCase().includes(search);
        if (!matchCity && !matchCar) return false;
      }
      if (this.filterStatus !== 'all' && trip.status !== this.filterStatus) {
        return false;
      }
      return true;
    }).sort((a, b) => {
      let compareA: any;
      let compareB: any;
      if (this.sortField === 'estimatedDepartureTime') {
        compareA = a.estimatedDepartureTime.toMillis();
        compareB = b.estimatedDepartureTime.toMillis();
      } else if (this.sortField === 'departureCity') {
        compareA = a.departureCity.toLowerCase();
        compareB = b.departureCity.toLowerCase();
      } else {
        compareA = a.status;
        compareB = b.status;
      }
      const comparison = compareA < compareB ? -1 : compareA > compareB ? 1 : 0;
      return this.sortDirection === 'asc' ? comparison : -comparison;
    });
  }

  initEditForm(): void {
    this.editForm = this.fb.group({
      carId: ['', Validators.required],
      departureCity: ['', Validators.required],
      arrivalCity: ['', Validators.required],
      estimatedDepartureTime: ['', Validators.required],
      estimatedArrivalTime: ['', Validators.required],
      status: ['pending', Validators.required],
    });
  }

  onSearchChange(): void { this.loadTrips(); }
  onFilterStatusChange(): void { this.loadTrips(); }
  
  onSortChange(field: typeof this.sortField): void {
    if (this.sortField === field) {
      this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this.sortField = field;
      this.sortDirection = 'asc';
    }
    this.loadTrips();
  }

  clearFilters(): void {
    this.searchText = '';
    this.filterStatus = 'all';
    this.sortField = 'estimatedDepartureTime';
    this.sortDirection = 'desc';
    this.loadTrips();
  }

  countByStatus(status: TripStatus): number {
    return this.filteredTrips.filter(t => t.status === status).length;
  }

  toggleSelectAll(): void {
    this.selectAll = !this.selectAll;
    if (this.selectAll) {
      this.filteredTrips.forEach(trip => {
        if (trip.id) this.selectedTrips.add(trip.id);
      });
    } else {
      this.selectedTrips.clear();
    }
  }

  toggleSelect(tripId: string): void {
    if (this.selectedTrips.has(tripId)) {
      this.selectedTrips.delete(tripId);
    } else {
      this.selectedTrips.add(tripId);
    }
  }

  async deleteSelected(): Promise<void> {
    if (this.selectedTrips.size === 0) return;
    const count = this.selectedTrips.size;
    if (!confirm(`üóëÔ∏è Supprimer ${count} trajet(s) ?`)) return;
    this.loading = true;
    try {
      await Promise.all(Array.from(this.selectedTrips).map(id =>
        this.firestoreService.deleteTrip(id)
      ));
      alert(`‚úÖ ${count} trajet(s) supprim√©(s) !`);
      this.selectedTrips.clear();
      this.selectAll = false;
    } catch (error: any) {
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.loading = false;
    }
  }

  openDetailsModal(trip: TripWithCar): void {
    this.detailsTrip = trip;
    this.showDetailsModal = true;
  }

  closeDetailsModal(): void {
    this.showDetailsModal = false;
    this.detailsTrip = null;
  }

  openEditModal(trip: Trip): void {
    this.selectedTrip = trip;
    const depTime = trip.estimatedDepartureTime.toDate();
    const arrTime = trip.estimatedArrivalTime.toDate();
    this.editForm.patchValue({
      carId: trip.carId,
      departureCity: trip.departureCity,
      arrivalCity: trip.arrivalCity,
      estimatedDepartureTime: this.toDatetimeLocal(depTime),
      estimatedArrivalTime: this.toDatetimeLocal(arrTime),
      status: trip.status,
    });
    this.showEditModal = true;
  }

  closeEditModal(): void {
    this.showEditModal = false;
    this.selectedTrip = null;
    this.editForm.reset();
  }

  async updateTrip(): Promise<void> {
    if (this.editForm.invalid || !this.selectedTrip?.id) {
      alert('‚ö†Ô∏è Formulaire invalide');
      return;
    }
    this.loading = true;
    try {
      const formValue = this.editForm.value;
      const updatedTrip: Trip = {
        ...this.selectedTrip,
        carId: formValue.carId,
        departureCity: formValue.departureCity,
        arrivalCity: formValue.arrivalCity,
        estimatedDepartureTime: Timestamp.fromDate(new Date(formValue.estimatedDepartureTime)),
        estimatedArrivalTime: Timestamp.fromDate(new Date(formValue.estimatedArrivalTime)),
        status: formValue.status,
        updatedAt: Timestamp.now(),
      };
      await this.firestoreService.updateTrip(updatedTrip);
      alert('‚úÖ Trajet mis √† jour !');
      this.closeEditModal();
    } catch (error: any) {
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.loading = false;
    }
  }

  async deleteTrip(trip: Trip): Promise<void> {
    if (!trip.id) return;
    if (!confirm(`üóëÔ∏è Supprimer ${trip.departureCity} ‚Üí ${trip.arrivalCity} ?`)) return;
    this.loading = true;
    try {
      await this.firestoreService.deleteTrip(trip.id);
      alert('‚úÖ Trajet supprim√© !');
    } catch (error: any) {
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.loading = false;
    }
  }

  async duplicateTrip(trip: Trip): Promise<void> {
    this.loading = true;
    try {
      await this.firestoreService.addTrip({
        ...trip,
        id: undefined,
        status: 'pending' as TripStatus,
        createdAt: undefined,
        updatedAt: undefined,
      });
      alert('‚úÖ Trajet dupliqu√© !');
    } catch (error: any) {
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.loading = false;
    }
  }

  async quickUpdateStatus(trip: Trip, newStatus: TripStatus): Promise<void> {
    if (!trip.id) return;
    this.loading = true;
    try {
      await this.firestoreService.updateTrip({
        ...trip,
        status: newStatus,
        updatedAt: Timestamp.now(),
      });
    } catch (error: any) {
      alert('‚ùå Erreur: ' + error.message);
    } finally {
      this.loading = false;
    }
  }

  goToCreateTrip(): void {
    this.router.navigate(['/trajets/saisie']);
  }

  exportToCSV(): void {
    const headers = ['D√©part', 'Arriv√©e', 'Date D√©part', 'Date Arriv√©e', 'Statut', 'Voiture'];
    const rows = this.filteredTrips.map(trip => [
      trip.departureCity,
      trip.arrivalCity,
      this.formatDate(trip.estimatedDepartureTime),
      this.formatDate(trip.estimatedArrivalTime),
      this.statusLabels[trip.status],
      trip.car ? `${trip.car.make} ${trip.car.model} (${trip.car.licensePlate})` : 'N/A'
    ]);
    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `trajets-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
  }

  private toDatetimeLocal(date: Date): string {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  formatDate(timestamp: Timestamp): string {
    const date = timestamp.toDate();
    return date.toLocaleDateString('fr-FR', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
    });
  }

  getCarInfo(car?: Car): string {
    if (!car) return 'N/A';
    return `${car.make} ${car.model} (${car.licensePlate})`;
  }
}


====== Fichier : ./src/app/pages/trips-history/trips-history-page.component.html ======
<div class="p-6 bg-gray-50 min-h-screen">
  <!-- HEADER -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-3xl font-bold text-gray-800">üöö Historique des Trajets</h2>
      <p class="text-gray-600 text-sm mt-1">G√©rez et suivez tous vos trajets</p>
    </div>
    <button
      (click)="openCreateModal()"
      class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-md flex items-center gap-2"
    >
      <span class="text-xl">‚ûï</span>
      <span>Nouveau Trajet</span>
    </button>
  </div>

  <ng-container *ngIf="trips$ | async as trips; else loadingTrips">
    
    <!-- BARRE D'OUTILS -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        
        <!-- Recherche -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">üîç Rechercher</label>
          <input
            type="text"
            [(ngModel)]="searchText"
            (ngModelChange)="onSearchChange()"
            placeholder="Ville, immatriculation..."
            class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- Filtre par statut -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">üìä Statut</label>
          <select
            [(ngModel)]="filterStatus"
            (ngModelChange)="onFilterStatusChange()"
            class="w-full border border-gray-300 rounded-md px-3 py-2"
          >
            <option value="all">Tous</option>
            <option value="pending">En attente</option>
            <option value="in_progress">En cours</option>
            <option value="completed">Termin√©</option>
            <option value="cancelled">Annul√©</option>
          </select>
        </div>

        <!-- Actions group√©es -->
        <div class="flex items-end gap-2">
          <button
            (click)="clearFilters()"
            class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition"
            title="R√©initialiser les filtres"
          >
            üîÑ Reset
          </button>
          <button
            (click)="exportToCSV()"
            class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition"
            title="Exporter en CSV"
          >
            üì• CSV
          </button>
        </div>
      </div>

      <!-- Actions pour s√©lection multiple -->
      <div *ngIf="selectedTrips.size > 0" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md flex justify-between items-center">
        <span class="text-sm text-blue-800 font-medium">
          {{ selectedTrips.size }} trajet(s) s√©lectionn√©(s)
        </span>
        <button
          (click)="deleteSelected()"
          class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition text-sm"
        >
          üóëÔ∏è Supprimer la s√©lection
        </button>
      </div>
    </div>

    <!-- STATISTIQUES -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-gray-500 text-sm">Total</p>
            <p class="text-2xl font-bold text-gray-800">{{ filteredTrips.length }}</p>
          </div>
          <div class="text-4xl">üöö</div>
        </div>
      </div>
      <div class="bg-yellow-50 rounded-lg shadow p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-yellow-700 text-sm">En attente</p>
            <p class="text-2xl font-bold text-yellow-800">{{ countByStatus('pending') }}</p>
          </div>
          <div class="text-4xl">‚è≥</div>
        </div>
      </div>
      <div class="bg-blue-50 rounded-lg shadow p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-blue-700 text-sm">En cours</p>
            <p class="text-2xl font-bold text-blue-800">{{ countByStatus('in_progress') }}</p>
          </div>
          <div class="text-4xl">üöó</div>
        </div>
      </div>
      <div class="bg-green-50 rounded-lg shadow p-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-green-700 text-sm">Termin√©s</p>
            <p class="text-2xl font-bold text-green-800">{{ countByStatus('completed') }}</p>
          </div>
          <div class="text-4xl">‚úÖ</div>
        </div>
      </div>
    </div>

    <!-- TABLEAU -->
    <div class="bg-white rounded-lg shadow-xl overflow-hidden">
      
      <div *ngIf="filteredTrips.length === 0" class="p-12 text-center">
        <div class="text-6xl mb-4">üì≠</div>
        <p class="text-xl text-gray-500 mb-4">Aucun trajet trouv√©</p>
        <button
          (click)="openCreateModal()"
          class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
        >
          Cr√©er votre premier trajet
        </button>
      </div>

      <div *ngIf="filteredTrips.length > 0" class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3">
                <input
                  type="checkbox"
                  [checked]="selectAll"
                  (change)="toggleSelectAll()"
                  class="rounded border-gray-300"
                />
              </th>
              <th 
                (click)="onSortChange('departureCity')"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
              >
                Trajet
                <span *ngIf="sortField === 'departureCity'">
                  {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Voiture</th>
              <th 
                (click)="onSortChange('estimatedDepartureTime')"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
              >
                D√©part
                <span *ngIf="sortField === 'estimatedDepartureTime'">
                  {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Arriv√©e</th>
              <th 
                (click)="onSortChange('status')"
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
              >
                Statut
                <span *ngIf="sortField === 'status'">
                  {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
                </span>
              </th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <tr *ngFor="let trip of filteredTrips" class="hover:bg-gray-50 transition">
              <td class="px-4 py-4">
                <input
                  type="checkbox"
                  [checked]="selectedTrips.has(trip.id!)"
                  (change)="toggleSelect(trip.id!)"
                  class="rounded border-gray-300"
                />
              </td>
              <td class="px-6 py-4">
                <div class="flex items-center cursor-pointer" (click)="openDetailsModal(trip)">
                  <div>
                    <div class="text-sm font-medium text-gray-900">
                      üöÄ {{ trip.departureCity }} ‚Üí üèÅ {{ trip.arrivalCity }}
                    </div>
                    <div class="text-xs text-gray-500" *ngIf="trip.steps && trip.steps.length > 0">
                      üõë {{ trip.steps.length }} √©tape(s)
                    </div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-700">
                <div *ngIf="trip.car">
                  <div class="font-medium">{{ trip.car.brand }} {{ trip.car.model }}</div>
                  <div class="text-xs text-gray-500">{{ trip.car.licensePlate }}</div>
                </div>
                <span *ngIf="!trip.car" class="text-gray-400">N/A</span>
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                {{ formatDate(trip.estimatedDepartureTime) }}
              </td>
              <td class="px-6 py-4 text-sm text-gray-600">
                {{ formatDate(trip.estimatedArrivalTime) }}
              </td>
              <td class="px-6 py-4">
                <select
                  [value]="trip.status"
                  (change)="quickUpdateStatus(trip, $any($event.target).value)"
                  class="px-3 py-1 rounded-full text-xs font-semibold border"
                  [ngClass]="statusColors[trip.status]"
                >
                  <option value="pending">{{ statusLabels.pending }}</option>
                  <option value="in_progress">{{ statusLabels.in_progress }}</option>
                  <option value="completed">{{ statusLabels.completed }}</option>
                  <option value="cancelled">{{ statusLabels.cancelled }}</option>
                </select>
              </td>
              <td class="px-6 py-4">
                <div class="flex gap-2">
                  <button
                    (click)="openEditModal(trip)"
                    class="text-blue-600 hover:text-blue-800 text-lg"
                    title="Modifier"
                  >
                    ‚úèÔ∏è
                  </button>
                  <button
                    (click)="duplicateTrip(trip)"
                    class="text-green-600 hover:text-green-800 text-lg"
                    title="Dupliquer"
                  >
                    üìã
                  </button>
                  <button
                    (click)="deleteTrip(trip)"
                    class="text-red-600 hover:text-red-800 text-lg"
                    title="Supprimer"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </ng-container>

  <ng-template #loadingTrips>
    <div class="bg-white rounded-lg shadow-xl p-12 text-center">
      <div class="text-6xl mb-4">‚è≥</div>
      <p class="text-xl text-gray-500">Chargement des trajets...</p>
    </div>
  </ng-template>
</div>

<!-- MODAL CR√âATION -->
<div
  *ngIf="showCreateModal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
  (click)="closeCreateModal()"
>
  <div
    class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800">‚ûï Nouveau Trajet</h3>
        <button
          (click)="closeCreateModal()"
          class="text-gray-500 hover:text-gray-700 text-3xl leading-none"
        >
          ‚úï
        </button>
      </div>

      <form [formGroup]="createForm" (ngSubmit)="createTrip()" class="space-y-5">
        <!-- Voiture -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            üöó Voiture <span class="text-red-500">*</span>
          </label>
          <select
            formControlName="carId"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"
          >
            <option value="" disabled>S√©lectionner</option>
            <ng-container *ngIf="availableCars$ | async as cars">
              <option *ngFor="let car of cars" [value]="car.id">
                {{ car.brand }} {{ car.model }} ({{ car.licensePlate }})
              </option>
            </ng-container>
          </select>
        </div>

        <!-- Villes -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              üöÄ Ville de D√©part <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              formControlName="departureCity"
              class="w-full border border-gray-300 rounded-md p-2"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              üèÅ Ville d'Arriv√©e <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              formControlName="arrivalCity"
              class="w-full border border-gray-300 rounded-md p-2"
            />
          </div>
        </div>

        <!-- Dates -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              ‚è∞ D√©part <span class="text-red-500">*</span>
            </label>
            <input
              type="datetime-local"
              formControlName="estimatedDepartureTime"
              class="w-full border border-gray-300 rounded-md p-2"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              ‚è±Ô∏è Arriv√©e <span class="text-red-500">*</span>
            </label>
            <input
              type="datetime-local"
              formControlName="estimatedArrivalTime"
              class="w-full border border-gray-300 rounded-md p-2"
            />
          </div>
        </div>

        <!-- Boutons -->
        <div class="flex gap-3 pt-4">
          <button
            type="submit"
            [disabled]="createForm.invalid || loading"
            class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-semibold transition"
          >
            <span *ngIf="!loading">‚úÖ Enregistrer</span>
            <span *ngIf="loading">‚è≥ Enregistrement...</span>
          </button>
          <button
            type="button"
            (click)="closeCreateModal()"
            [disabled]="loading"
            class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 disabled:bg-gray-400 font-semibold transition"
          >
            ‚ùå Annuler
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODALS D'√âDITION / D√âTAILS (inchang√©s, d√©j√† pr√©sents dans ton code pr√©c√©dent) -->


====== Fichier : ./src/app/pages/trips-history/trips-history-page.component.ts ======
import { Component, OnInit, inject } from '@angular/core';
import { CommonModule, DatePipe } from '@angular/common';
import { FormsModule, ReactiveFormsModule, FormBuilder, FormGroup, Validators } from '@angular/forms';
import { AuthService } from '../../services/auth.service';
import { FirestoreService, Trip } from '../../services/firestore.service';
import { Car } from '../../interfaces/car.interface';
import { Observable, of } from 'rxjs';
import { map, switchMap, tap } from 'rxjs/operators';
import { Timestamp } from '@angular/fire/firestore';

// Interface √©tendue pour le template
interface TripWithCar extends Trip {
  car?: Car;
}

@Component({
  selector: 'app-trips-history-page',
  standalone: true,
  imports: [CommonModule, FormsModule, ReactiveFormsModule, DatePipe], 
  templateUrl: './trips-history-page.component.html'
})
export class TripsHistoryPageComponent implements OnInit {
  private auth = inject(AuthService);
  private firestoreService = inject(FirestoreService);
  private fb = inject(FormBuilder);

  trips$!: Observable<TripWithCar[]>;
  availableCars$!: Observable<Car[]>;
  
  // Donn√©es locales
  allTrips: TripWithCar[] = [];
  filteredTrips: TripWithCar[] = [];
  
  // Filtres & Tri
  searchTerm = ''; // Alias pour searchText du template
  searchText = ''; 
  filterStatus = 'all';
  sortField = 'date';
  sortDirection: 'asc' | 'desc' = 'desc';
  
  // S√©lection multiple
  selectedTrips = new Set<string>();
  selectAll = false;

  // UI State
  loading = false;
  showCreateModal = false;
  createForm: FormGroup;
  
  // Edition (Modal d√©tails/edit)
  editingTrip: TripWithCar | null = null;
  isModalOpen = false; // Utilis√© pour l'√©dition rapide
  
  COMPANY_ID = '';

  // Mapping des labels de statut
  statusLabels: any = {
    pending: 'En attente',
    in_progress: 'En cours',
    completed: 'Termin√©',
    cancelled: 'Annul√©'
  };
  
  // Mapping des couleurs
  statusColors: any = {
    pending: 'bg-yellow-100 text-yellow-800',
    in_progress: 'bg-blue-100 text-blue-800',
    completed: 'bg-green-100 text-green-800',
    cancelled: 'bg-red-100 text-red-800'
  };

  constructor() {
    this.createForm = this.fb.group({
      departure: ['', Validators.required],
      arrival: ['', Validators.required],
      date: [new Date().toISOString().split('T')[0], Validators.required],
      carId: ['', Validators.required],
      status: ['pending']
    });
  }

  ngOnInit() {
    this.auth.user$.subscribe(user => {
      if (user) {
        this.COMPANY_ID = user.uid;
        this.loadData();
      }
    });
  }

  loadData() {
    this.loading = true;
    this.availableCars$ = this.firestoreService.getCars(this.COMPANY_ID);

    this.firestoreService.getTrips(this.COMPANY_ID).pipe(
      switchMap(trips => {
        if (!trips.length) return of([]);
        return this.availableCars$.pipe(
          map(cars => {
            return trips.map(trip => {
              const car = cars.find(c => c.id === trip.carId);
              return { ...trip, car } as TripWithCar;
            });
          })
        );
      })
    ).subscribe({
      next: (trips) => {
        this.allTrips = trips;
        this.applyFilters();
        this.loading = false;
      },
      error: (err) => {
        console.error(err);
        this.loading = false;
      }
    });
  }

  // --- FILTRES & TRI ---

  onSearchChange() {
    this.searchTerm = this.searchText; // Synchro
    this.applyFilters();
  }

  onFilterStatusChange() {
    this.applyFilters();
  }
  
  clearFilters() {
    this.searchText = '';
    this.searchTerm = '';
    this.filterStatus = 'all';
    this.applyFilters();
  }

  applyFilters() {
    let res = [...this.allTrips];

    // Filtre Texte
    if (this.searchText) {
      const term = this.searchText.toLowerCase();
      res = res.filter(t => 
        (t.departure || '').toLowerCase().includes(term) ||
        (t.arrival || '').toLowerCase().includes(term) ||
        (t.car?.brand || '').toLowerCase().includes(term)
      );
    }

    // Filtre Statut
    if (this.filterStatus !== 'all') {
      res = res.filter(t => t.status === this.filterStatus);
    }

    // Tri
    res.sort((a: any, b: any) => {
      let valA = a[this.sortField];
      let valB = b[this.sortField];
      
      // Gestion cas date/timestamp
      if (this.sortField === 'estimatedDepartureTime' || this.sortField === 'date') {
         valA = new Date(a.date || 0).getTime();
         valB = new Date(b.date || 0).getTime();
      }

      if (valA < valB) return this.sortDirection === 'asc' ? -1 : 1;
      if (valA > valB) return this.sortDirection === 'asc' ? 1 : -1;
      return 0;
    });

    this.filteredTrips = res;
  }

  onSortChange(field: string) {
    if (this.sortField === field) {
      this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this.sortField = field;
      this.sortDirection = 'asc';
    }
    this.applyFilters();
  }

  // --- SELECTION MULTIPLE ---

  toggleSelectAll() {
    this.selectAll = !this.selectAll;
    this.selectedTrips.clear();
    if (this.selectAll) {
      this.filteredTrips.forEach(t => {
        if (t.id) this.selectedTrips.add(t.id);
      });
    }
  }

  toggleSelect(id: string) {
    if (this.selectedTrips.has(id)) {
      this.selectedTrips.delete(id);
    } else {
      this.selectedTrips.add(id);
    }
    this.selectAll = this.selectedTrips.size === this.filteredTrips.length;
  }

  async deleteSelected() {
    if (!confirm(`Supprimer ${this.selectedTrips.size} trajets ?`)) return;
    
    const promises = Array.from(this.selectedTrips).map(id => 
      this.firestoreService.deleteTrip(id)
    );
    
    await Promise.all(promises);
    this.selectedTrips.clear();
    this.selectAll = false;
    this.loadData();
  }

  // --- ACTIONS CRUD ---

  openCreateModal() {
    this.createForm.reset({
      status: 'pending',
      date: new Date().toISOString().split('T')[0]
    });
    this.showCreateModal = true;
  }

  closeCreateModal() {
    this.showCreateModal = false;
  }

  async createTrip() {
    if (this.createForm.invalid) return;
    this.loading = true;
    
    try {
      const formData = this.createForm.value;
      // Construction objet Trip compatible
      const newTrip: any = {
        companyId: this.COMPANY_ID,
        departure: formData.departure,
        arrival: formData.arrival,
        date: formData.date,
        carId: formData.carId,
        status: formData.status,
        createdAt: new Date()
      };
      
      await this.firestoreService.addTrip(newTrip);
      this.closeCreateModal();
      this.loadData();
    } catch (e) {
      console.error(e);
    } finally {
      this.loading = false;
    }
  }

  deleteTrip(trip: TripWithCar) {
    if (!trip.id) return;
    if (confirm('Supprimer ce trajet ?')) {
      this.firestoreService.deleteTrip(trip.id).then(() => this.loadData());
    }
  }

  async duplicateTrip(trip: TripWithCar) {
    const { id, ...data } = trip;
    const copy = { ...data, status: 'pending', createdAt: new Date() };
    await this.firestoreService.addTrip(copy);
    this.loadData();
  }
  
  openEditModal(trip: TripWithCar) {
    this.editingTrip = { ...trip };
    this.isModalOpen = true;
  }
  
  // Alias pour compatibilit√© template
  openDetailsModal(trip: TripWithCar) {
    this.openEditModal(trip);
  }

  // --- HELPERS ---

  countByStatus(status: string): number {
    return this.allTrips.filter(t => t.status === status).length;
  }

  async quickUpdateStatus(trip: TripWithCar, status: any) {
    if (!trip.id) return;
    const newStatus = status.value || status; 
    await this.firestoreService.updateTrip({ id: trip.id, status: newStatus });
    trip.status = newStatus; // Optimistic update
    this.applyFilters(); // Re-tri √©ventuel
  }

  formatDate(val: any): string {
    if (!val) return '-';
    // Gestion Timestamp Firestore ou Date string
    const date = val.toDate ? val.toDate() : new Date(val);
    return new DatePipe('en-US').transform(date, 'dd/MM/yyyy HH:mm') || '-';
  }

  exportToCSV() {
    console.log("Export CSV non impl√©ment√© pour l'instant");
    alert("Fonctionnalit√© √† venir !");
  }
}


====== Fichier : ./src/app/pages/cars-management/cars-management-page.component.ts ======
import { Component, OnInit, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { AuthService } from '../../services/auth.service';
import { FirestoreService } from '../../services/firestore.service';
import { Car } from '../../interfaces/car.interface';

@Component({
  selector: 'app-cars-management-page',
  standalone: true,
  imports: [CommonModule, FormsModule],
  templateUrl: './cars-management-page.component.html'
})
export class CarsManagementPageComponent implements OnInit {
  private auth = inject(AuthService);
  private firestoreService = inject(FirestoreService);

  cars: Car[] = [];
  loading = true;
  showForm = false;
  currentUser: any = null;

  // Mod√®le pour le formulaire
  newCar: Partial<Car> = {
    brand: '',
    model: '',
    licensePlate: '',
    capacity: 0,
    status: 'available'
  };

  ngOnInit() {
    // On r√©cup√®re l'utilisateur connect√© pour charger SES voitures
    this.auth.user$.subscribe(async (user) => {
      this.currentUser = user;
      if (user) {
        await this.loadCars();
      }
    });
  }

  async loadCars() {
    if (!this.currentUser) return;
    this.loading = true;
    try {
      this.cars = await this.firestoreService.getUserCars(this.currentUser.uid);
    } catch (error) {
      console.error("Erreur chargement voitures:", error);
    } finally {
      this.loading = false;
    }
  }

  toggleForm() {
    this.showForm = !this.showForm;
  }

  async onSubmit() {
    if (!this.currentUser) return;

    try {
      const carToAdd: Car = {
        ownerId: this.currentUser.uid,
        brand: this.newCar.brand || '',
        model: this.newCar.model || '',
        licensePlate: this.newCar.licensePlate || '',
        capacity: this.newCar.capacity || 0,
        status: 'available'
      };

      await this.firestoreService.addCar(carToAdd);
      
      // Reset du formulaire et rechargement
      this.newCar = { brand: '', model: '', licensePlate: '', capacity: 0, status: 'available' };
      this.showForm = false;
      await this.loadCars();
    } catch (error) {
      console.error("Erreur lors de l'ajout:", error);
    }
  }

  async deleteCar(carId: string | undefined) {
    if (!carId) return;
    if (confirm('Voulez-vous vraiment supprimer ce v√©hicule ?')) {
      await this.firestoreService.deleteCar(carId);
      await this.loadCars();
    }
  }
}


====== Fichier : ./src/app/pages/cars-management/cars-management-page.component.html ======
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  
  <!-- En-t√™te avec le Bouton Ajouter -->
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Mes V√©hicules</h1>
      <p class="text-sm text-gray-500 mt-1">G√©rez votre flotte de transport</p>
    </div>
    <button (click)="toggleForm()" 
      class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm font-medium">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
      </svg>
      {{ showForm ? 'Fermer' : 'Ajouter une voiture' }}
    </button>
  </div>

  <!-- Formulaire d'ajout (Affichage conditionnel) -->
  <div *ngIf="showForm" class="mb-8 bg-gray-50 border border-gray-200 rounded-xl p-6 animate-fade-in-down">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Nouveau V√©hicule</h3>
    <form (ngSubmit)="onSubmit()" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Marque</label>
        <input type="text" [(ngModel)]="newCar.brand" name="brand" required placeholder="ex: Renault"
               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Mod√®le</label>
        <input type="text" [(ngModel)]="newCar.model" name="model" required placeholder="ex: Master"
               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Immatriculation</label>
        <input type="text" [(ngModel)]="newCar.licensePlate" name="licensePlate" required placeholder="AA-123-BB"
               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Capacit√© (m3)</label>
        <input type="number" [(ngModel)]="newCar.capacity" name="capacity" required
               class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
      </div>

      <div class="md:col-span-2 flex justify-end gap-3 mt-2">
        <button type="button" (click)="toggleForm()" class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">Annuler</button>
        <button type="submit" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700 shadow-sm">Enregistrer</button>
      </div>
    </form>
  </div>

  <!-- Liste des voitures -->
  <div *ngIf="loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
    <p class="mt-2 text-gray-500">Chargement...</p>
  </div>

  <div *ngIf="!loading && cars.length === 0" class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300">
    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
    </svg>
    <h3 class="mt-2 text-sm font-medium text-gray-900">Aucune voiture</h3>
    <p class="mt-1 text-sm text-gray-500">Commencez par ajouter votre premier v√©hicule.</p>
  </div>

  <div *ngIf="!loading && cars.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div *ngFor="let car of cars" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
      <div class="flex justify-between items-start mb-4">
        <div class="p-3 bg-blue-50 rounded-lg text-blue-600">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12" />
          </svg>
        </div>
        <span class="inline-flex items-center rounded-full bg-green-50 px-2 py-1 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">Disponible</span>
      </div>
      
      <h3 class="text-lg font-bold text-gray-900">{{ car.brand }} {{ car.model }}</h3>
      <p class="text-sm text-gray-500 mb-4">{{ car.licensePlate }}</p>
      
      <div class="border-t border-gray-100 pt-4 flex justify-between items-center">
        <span class="text-sm font-medium text-gray-600">Capacit√©: {{ car.capacity }} m¬≥</span>
        
        <button (click)="deleteCar(car.id)" class="text-red-400 hover:text-red-600 text-sm font-medium transition-colors">
          Supprimer
        </button>
      </div>
    </div>
  </div>

</div>


====== Fichier : ./src/app/pages/chat-page/chat-page.component.ts ======
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  standalone: true,
  selector: 'app-chat-page',
  templateUrl: './chat-page.component.html',
  imports: [CommonModule],
})
export class ChatPageComponent {
  // Quand tu brancheras <app-chat>, tu pourras exposer ici :
  // selectedConversationId = 'demo-conversation';
  // currentUserId = 'demo-user';
}


====== Fichier : ./src/app/pages/chat-page/chat-page.component.html ======
<div class="p-4 h-full flex flex-col">
  <h1 class="text-lg font-semibold text-gray-800 mb-2">Chat</h1>
  <p class="text-xs text-gray-500 mb-4">
    Interface de messagerie entre transporteurs / collaborateurs.
  </p>

  <div class="flex-1 min-h-[300px] flex items-center justify-center border border-dashed border-gray-300 rounded-xl bg-gray-50 text-xs text-gray-500 text-center px-4">
    Placeholder de la page de chat.
    Branche ici ton composant &lt;app-chat&gt; plus tard.
  </div>
</div>


====== Fichier : ./src/app/pages/trip-form/trip-form-page.component.ts ======
import { Component } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  standalone: true,
  selector: 'app-trip-form-page',
  templateUrl: './trip-form-page.component.html',
  imports: [CommonModule],
})
export class TripFormPageComponent {}


====== Fichier : ./src/app/pages/trip-form/trip-form-page.component.html ======
<div class="p-4 max-w-3xl space-y-4">
  <div>
    <h1 class="text-lg font-semibold text-gray-800">Saisie de trajet</h1>
    <p class="text-xs text-gray-500">
      Enregistrez un nouveau trajet et affectez-le √† un v√©hicule.
    </p>
  </div>

  <form class="bg-white rounded-xl shadow border border-gray-100 p-4 space-y-4 text-sm">
    <div class="grid gap-4 md:grid-cols-2">
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Date de d√©part</label>
        <input type="date" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Heure de d√©part</label>
        <input type="time" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Ville de d√©part</label>
        <input type="text" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex : Tunis" />
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Ville d‚Äôarriv√©e</label>
        <input type="text" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex : Sfax" />
      </div>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">V√©hicule</label>
        <select class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option>Choisir un v√©hicule</option>
          <option>AA-123-BB - Renault Trafic</option>
          <option>CC-456-DD - Peugeot Boxer</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-600 mb-1">Capacit√© dispo (kg)</label>
        <input type="number" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
    </div>

    <div>
      <label class="block text-xs font-medium text-gray-600 mb-1">Notes / instructions</label>
      <textarea rows="3" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Infos compl√©mentaires sur le trajet..."></textarea>
    </div>

    <div class="flex justify-end gap-2 text-xs">
      <button type="button" class="px-3 py-2 rounded-lg border border-gray-300 hover:bg-gray-50">
        Annuler
      </button>
      <button type="submit" class="px-3 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
        Enregistrer le trajet
      </button>
    </div>
  </form>
</div>


====== Fichier : ./src/app/pages/users/users-page.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { AuthService } from '../../services/auth.service';
import { CollaborationService } from '../../services/collaboration.service';
import { AppUser } from '../../interfaces/user.interface';
import { Observable } from 'rxjs';
import { User } from '@angular/fire/auth';

@Component({
  selector: 'app-users-page',
  standalone: true,
  imports: [CommonModule, RouterModule],
  templateUrl: './users-page.component.html',
})
export class UsersPageComponent {
  private authService = inject(AuthService);
  private collab = inject(CollaborationService);

  currentUser$ = this.authService.user$;
  users$: Observable<AppUser[]>;

  loadingRequest = false;
  message = '';
  messageType: 'success' | 'error' = 'success';

  constructor() {
    this.users$ = this.collab.getAllUsers();
  }

  async sendRequest(target: AppUser, currentUser: User | null): Promise<void> {
    if (!currentUser) {
      this.message = 'Vous devez √™tre connect√©.';
      this.messageType = 'error';
      return;
    }
    this.loadingRequest = true;
    this.message = '';
    
    try {
      await this.collab.sendRequest(currentUser.uid, target.uid);
      this.message = `‚úÖ Demande envoy√©e √† ${target.displayName} !`;
      this.messageType = 'success';
    } catch (e: any) {
      this.message = `‚ùå ${e.message}`;
      this.messageType = 'error';
    } finally {
      this.loadingRequest = false;
    }
  }
}


====== Fichier : ./src/app/pages/users/users-page.component.html ======
<div class="p-6 bg-gray-50 min-h-screen">
  <div class="max-w-6xl mx-auto">
    
    <!-- En-t√™te -->
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">ü§ù Demandes de collaboration</h1>
        <p class="text-gray-600 mt-1">Trouvez d'autres transporteurs et envoyez-leur une demande pour collaborer.</p>
      </div>
      
      <div class="flex gap-3">
        <a routerLink="/collaborations" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium shadow-sm">
          üìÇ Voir mes demandes re√ßues
        </a>
        <!-- Bouton d√©connexion optionnel ici si besoin -->
      </div>
    </div>

    <!-- Feedback Message -->
    <div *ngIf="message" class="mb-6 p-4 rounded-lg border flex items-center gap-3 animate-fade-in"
         [ngClass]="messageType === 'error' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-green-50 border-green-200 text-green-700'">
      <span class="text-xl">{{ messageType === 'error' ? '‚ö†Ô∏è' : '‚úÖ' }}</span>
      <span class="font-medium">{{ message }}</span>
    </div>

    <!-- Liste des Utilisateurs -->
    <ng-container *ngIf="(currentUser$ | async) as me">
      <ng-container *ngIf="(users$ | async) as users; else loading">
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div *ngFor="let u of users" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200 flex flex-col">
            
            <div class="flex items-start justify-between mb-4">
              <div class="flex items-center gap-4">
                <!-- Avatar -->
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold text-xl shadow-sm">
                  {{ u.displayName?.charAt(0)?.toUpperCase() || '?' }}
                </div>
                <div>
                  <h3 class="text-lg font-bold text-gray-900 leading-tight">{{ u.displayName }}</h3>
                  <p class="text-sm text-gray-500">{{ u.email }}</p>
                </div>
              </div>
              <span *ngIf="u.uid === me.uid" class="px-2 py-1 bg-blue-50 text-blue-700 text-xs font-bold uppercase rounded-md tracking-wider border border-blue-100">
                Moi
              </span>
            </div>

            <div class="mt-auto pt-4 border-t border-gray-100">
              <ng-container *ngIf="u.uid !== me.uid">
                <button
                  (click)="sendRequest(u, me)"
                  [disabled]="loadingRequest"
                  class="w-full py-2.5 px-4 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 active:bg-blue-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2 group"
                >
                  <span class="group-hover:scale-110 transition-transform">üëã</span>
                  <span>Envoyer une demande</span>
                </button>
              </ng-container>
              <div *ngIf="u.uid === me.uid" class="text-center py-2 text-gray-400 text-sm italic">
                Votre profil
              </div>
            </div>

          </div>
        </div>

        <div *ngIf="users.length === 0" class="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
          <div class="text-4xl mb-3">üì≠</div>
          <p class="text-gray-500 text-lg">Aucun autre utilisateur trouv√©.</p>
        </div>

      </ng-container>
    </ng-container>

    <ng-template #loading>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Skeleton Loader -->
        <div *ngFor="let i of [1,2,3]" class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm animate-pulse">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-gray-200 rounded-full"></div>
            <div class="flex-1">
              <div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div>
              <div class="h-3 bg-gray-200 rounded w-1/2"></div>
            </div>
          </div>
          <div class="h-10 bg-gray-200 rounded w-full mt-4"></div>
        </div>
      </div>
    </ng-template>

  </div>
</div>


====== Fichier : ./src/app/pages/collab-requests/collab-requests-page.component.html ======


<div class="min-h-screen bg-gray-50 p-6">
  <div class="max-w-6xl mx-auto">
    
    <!-- Titre & Tabs -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-6">Gestion des Collaborations</h1>
      
      <div class="flex space-x-4 border-b border-gray-200">
        <button (click)="setActiveTab('search')" 
                [class]="activeTab === 'search' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                class="pb-3 px-1 border-b-2 font-medium text-sm transition-colors">
          üîç Rechercher
        </button>
        
        <button (click)="setActiveTab('pending')" 
                class="relative pb-3 px-1 border-b-2 font-medium text-sm transition-colors"
                [class]="activeTab === 'pending' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'">
          üîî Demandes re√ßues
          <ng-container *ngIf="pendingRequests$ | async as pending">
            <span *ngIf="pending.length > 0" class="absolute -top-1 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
              {{ pending.length }}
            </span>
          </ng-container>
        </button>

        <button (click)="setActiveTab('accepted')" 
                [class]="activeTab === 'accepted' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'"
                class="pb-3 px-1 border-b-2 font-medium text-sm transition-colors">
          ‚úÖ Mes Collaborateurs
        </button>
      </div>
    </div>

    <!-- Contenu Onglet : RECHERCHE -->
    <div *ngIf="activeTab === 'search'" class="animate-fade-in">
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <ng-container *ngIf="allUsers$ | async as users">
          <div *ngFor="let user of users" class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-lg">
                {{ user.displayName?.charAt(0) || 'U' }}
              </div>
              <div>
                <h3 class="font-bold text-gray-900">{{ user.displayName || 'Utilisateur' }}</h3>
                <p class="text-xs text-gray-500">{{ user.email }}</p>
              </div>
            </div>
            
            <ng-container *ngIf="currentUser$ | async as currentUser">
              <button *ngIf="user.uid !== currentUser.uid"
                      (click)="sendRequest(user.uid, currentUser.uid)"
                      class="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
                Envoyer une demande
              </button>
            </ng-container>
          </div>
        </ng-container>
      </div>
    </div>

    <!-- Contenu Onglet : DEMANDES RE√áUES (Pending) -->
    <div *ngIf="activeTab === 'pending'" class="animate-fade-in">
      <ng-container *ngIf="pendingRequests$ | async as requests">
        <div *ngIf="requests.length === 0" class="text-center py-12 bg-white rounded-xl border border-dashed">
          <p class="text-gray-500">Aucune demande en attente.</p>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div *ngFor="let req of requests" class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-yellow-400 flex justify-between items-center">
            <div>
              <p class="text-sm text-gray-500">Demande de l'utilisateur ID:</p>
              <p class="font-mono font-bold text-gray-800">{{ req.fromUserId | slice:0:8 }}...</p>
              <p class="text-xs text-gray-400 mt-1">Re√ßu le {{ req.createdAt?.seconds * 1000 | date:'dd/MM/yyyy' }}</p>
            </div>
            <div class="flex gap-2">
              <button (click)="accept(req)" class="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-semibold hover:bg-green-200">
                Accepter
              </button>
              <button (click)="decline(req)" class="px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-semibold hover:bg-red-200">
                Refuser
              </button>
            </div>
          </div>
        </div>
      </ng-container>
    </div>

    <!-- Contenu Onglet : COLLABORATIONS ACCEPT√âES -->
    <div *ngIf="activeTab === 'accepted'" class="animate-fade-in">
      <ng-container *ngIf="acceptedCollaborations$ | async as collabs">
        <div *ngIf="collabs.length === 0" class="text-center py-12 bg-white rounded-xl border border-dashed">
          <p class="text-gray-500">Vous n'avez pas encore de collaborateurs.</p>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <div *ngFor="let collab of collabs" class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex justify-between items-center group">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span class="font-bold text-gray-800">Collaboration Active</span>
              </div>
              <p class="text-xs text-gray-500">ID Lien : {{ collab.id }}</p>
            </div>
            
            <button (click)="deleteCollab(collab)" 
                    class="opacity-0 group-hover:opacity-100 transition-opacity px-3 py-1.5 bg-gray-100 text-gray-600 hover:bg-red-100 hover:text-red-600 rounded-lg text-sm">
              Supprimer
            </button>
          </div>
        </div>
      </ng-container>
    </div>

  </div>
</div>


====== Fichier : ./src/app/pages/collab-requests/collab-requests-page.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { AuthService } from '../../services/auth.service';
import { CollaborationService, CollaborationRequest } from '../../services/collaboration.service';
import {  } from '../../components/header/header.component';
import { Observable, switchMap, of, combineLatest, map } from 'rxjs';

@Component({
  selector: 'app-collab-requests-page',
  standalone: true,
  imports: [CommonModule, RouterModule, ],
  templateUrl: './collab-requests-page.component.html',
})
export class CollaborationRequestsPageComponent {
  private auth = inject(AuthService);
  private collab = inject(CollaborationService);

  currentUser$ = this.auth.user$;
  activeTab: 'search' | 'pending' | 'accepted' = 'search';

  // Donn√©es
  allUsers$ = this.collab.getAllUsers();
  
  pendingRequests$ = this.currentUser$.pipe(
    switchMap(user => user ? this.collab.getPendingRequests(user.uid) : of([]))
  );

  acceptedCollaborations$ = this.currentUser$.pipe(
    switchMap(user => user ? this.collab.getAcceptedCollaborations(user.uid) : of([]))
  );

  // Actions
  async sendRequest(targetId: string, currentUserId: string) {
    try {
      await this.collab.sendRequest(currentUserId, targetId);
      alert('‚úÖ Demande envoy√©e !');
    } catch (err: any) {
      alert('‚ùå ' + err.message);
    }
  }

  async accept(req: CollaborationRequest) {
    if(!req.id) return;
    try {
      await this.collab.acceptRequest(req.id);
    } catch (e) { console.error(e); }
  }

  async decline(req: CollaborationRequest) {
    if(!req.id) return;
    if(confirm('Refuser cette demande ?')) {
      await this.collab.declineRequest(req.id);
    }
  }

  async deleteCollab(req: CollaborationRequest) {
    if(!req.id) return;
    if(confirm('√ätes-vous s√ªr de vouloir supprimer cette collaboration ?')) {
      await this.collab.deleteCollaboration(req.id);
    }
  }

  setActiveTab(tab: 'search' | 'pending' | 'accepted') {
    this.activeTab = tab;
  }
}


====== Fichier : ./src/app/pages/shared-trips/shared-trips-page.component.html ======
<div class="p-6 bg-gray-50 min-h-screen">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold text-gray-800">Trajets des collaborateurs</h1>
    <a routerLink="/" class="text-sm text-blue-600 underline">Retour</a>
  </div>

  <ng-container *ngIf="sharedTrips$ | async as trips">
    <div *ngIf="trips.length === 0" class="text-gray-500">
      Aucun trajet partag√© pour le moment.
    </div>

    <div class="grid md:grid-cols-2 gap-4" *ngIf="trips.length > 0">
      <div *ngFor="let t of trips" class="bg-white rounded shadow p-4">
        <p class="font-semibold text-gray-800">
          {{ t.departureCity }} ‚Üí {{ t.arrivalCity }}
        </p>
        <p class="text-xs text-gray-500">
          D√©part : {{ formatDate(t.estimatedDepartureTime) }}
        </p>
        <p class="text-xs text-gray-500">
          Arriv√©e : {{ formatDate(t.estimatedArrivalTime) }}
        </p>
        <p class="text-xs text-gray-400 mt-1">
          Driver : {{ t.driverId }}
        </p>
      </div>
    </div>
  </ng-container>
</div>


====== Fichier : ./src/app/pages/shared-trips/shared-trips-page.component.ts ======
import { Component, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { AuthService } from '../../services/auth.service';
import { CollaborationService } from '../../services/collaboration.service';
import { HeaderComponent } from '../../components/header/header.component';
import { switchMap, of } from 'rxjs';

@Component({
  selector: 'app-shared-trips-page',
  standalone: true,
  imports: [CommonModule, HeaderComponent],
  template: `
    <app-header></app-header>
    <div class="p-6">
      <h1 class="text-2xl font-bold mb-4">Trajets Partag√©s</h1>
      <ng-container *ngIf="sharedTrips$ | async as trips">
        <div *ngIf="trips.length === 0" class="text-gray-500">
          Aucun trajet partag√© pour le moment.
        </div>
        <div *ngFor="let trip of trips" class="bg-white p-4 rounded-lg shadow mb-3">
          {{ trip | json }}
        </div>
      </ng-container>
    </div>
  `
})
export class SharedTripsPageComponent {
  private auth = inject(AuthService);
  private collab = inject(CollaborationService);

  sharedTrips$ = this.auth.user$.pipe(
    switchMap(user => user ? this.collab.getSharedTripsForUser(user.uid) : of([]))
  );
}


====== Fichier : ./src/app/services/firestore.ts ======
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root',
})
export class Firestore {
  
}


====== Fichier : ./src/app/services/chat.service.ts ======
import { Injectable } from '@angular/core';
import {
  Database,
  ref,
  push,
  query,
  orderByChild,
  onValue,
  serverTimestamp,
} from '@angular/fire/database';
import { Observable } from 'rxjs';

export interface ChatMessage {
  id?: string;
  senderId: string;
  text: string;
  createdAt: number;
}

@Injectable({
  providedIn: 'root',
})
export class ChatService {
  constructor(private database: Database) {}

  // R√©cup√©rer les messages en temps r√©el
  getMessages(conversationId: string): Observable<ChatMessage[]> {
    return new Observable((observer) => {
      const messagesRef = ref(
        this.database,
        `conversations/${conversationId}/messages`
      );
      const q = query(messagesRef, orderByChild('createdAt'));

      const unsubscribe = onValue(
        q,
        (snapshot) => {
          const messages: ChatMessage[] = [];
          snapshot.forEach((childSnapshot) => {
            messages.push({
              id: childSnapshot.key || undefined,
              ...childSnapshot.val(),
            });
          });
          observer.next(messages);
        },
        (error) => {
          observer.error(error);
        }
      );

      return () => unsubscribe();
    });
  }

  // Envoyer un message
  async sendMessage(
    conversationId: string,
    senderId: string,
    text: string
  ): Promise<void> {
    const messagesRef = ref(
      this.database,
      `conversations/${conversationId}/messages`
    );

    const message = {
      senderId,
      text,
      createdAt: serverTimestamp(),
    };

    await push(messagesRef, message);
  }
}


====== Fichier : ./src/app/services/auth.service.ts ======
import { Injectable, inject } from '@angular/core';
import { 
  Auth, 
  authState, 
  signInWithEmailAndPassword, 
  createUserWithEmailAndPassword, 
  signOut, 
  updateProfile, 
  User,
  setPersistence,
  browserLocalPersistence,
  GoogleAuthProvider,
  signInWithPopup
} from '@angular/fire/auth';
import { Firestore, doc, setDoc } from '@angular/fire/firestore';
import { Observable, from } from 'rxjs';
import { switchMap } from 'rxjs/operators';
import { AppUser } from '../interfaces/user.interface';

@Injectable({
  providedIn: 'root'
})
export class AuthService {
  private auth: Auth = inject(Auth);
  private firestore: Firestore = inject(Firestore);

  user$: Observable<User | null> = authState(this.auth);

  constructor() {
    setPersistence(this.auth, browserLocalPersistence)
      .then(() => console.log('üîê Persistance active'))
      .catch((e) => console.error('Erreur persistance:', e));
  }

  // Connexion Email/Pass
  login(email: string, pass: string) {
    return from(signInWithEmailAndPassword(this.auth, email, pass));
  }

  // Connexion Google (Ajout√©)
  loginWithGoogle() {
    const provider = new GoogleAuthProvider();
    return from(signInWithPopup(this.auth, provider)).pipe(
      switchMap(async (credential) => {
        // On cr√©e aussi le document user si c'est la premi√®re connexion
        const user = credential.user;
        const userDoc = doc(this.firestore, `users/${user.uid}`);
        const userData: AppUser = {
          uid: user.uid,
          email: user.email || '',
          displayName: user.displayName || 'Utilisateur Google',
          photoURL: user.photoURL || '',
          role: 'transporteur'
        };
        // setDoc avec merge:true pour ne pas √©craser un user existant
        await setDoc(userDoc, userData, { merge: true });
        return user;
      })
    );
  }

  // Inscription (Renomm√© en signUp pour compatibilit√©)
  signUp(email: string, pass: string, name: string) {
    return from(createUserWithEmailAndPassword(this.auth, email, pass)).pipe(
      switchMap(async (credential) => {
        const user = credential.user;
        
        await updateProfile(user, { displayName: name });
        
        const userDoc = doc(this.firestore, `users/${user.uid}`);
        const userData: AppUser = {
          uid: user.uid,
          email: user.email || '',
          displayName: name,
          photoURL: user.photoURL || '',
          role: 'transporteur'
        };
        
        await setDoc(userDoc, userData);
        return user;
      })
    );
  }

  // D√©connexion
  logout() {
    return from(signOut(this.auth));
  }
}


====== Fichier : ./src/app/services/firestore.service.ts ======
import { Injectable, inject } from '@angular/core';
import { 
  Firestore, 
  collection, 
  query, 
  where, 
  getDocs, 
  addDoc, 
  doc, 
  deleteDoc, 
  updateDoc,
  collectionData,
  Timestamp
} from '@angular/fire/firestore';
import { Car } from '../interfaces/car.interface';
import { Observable, from } from 'rxjs';
import { map } from 'rxjs/operators';

// Interface Trip enrichie pour correspondre √† vos composants existants
export interface Trip {
  id?: string;
  userId?: string; // Optionnel car parfois c'est companyId/driverId
  companyId?: string;
  driverId?: string;
  
  // Champs de localisation
  departure: string; // Utilis√© pour l'affichage simple (ville d√©part)
  arrival: string;   // Utilis√© pour l'affichage simple (ville arriv√©e)
  departureCity?: string; // Alias pour compatibilit√©
  arrivalCity?: string;   // Alias pour compatibilit√©
  
  // Champs de date
  date: string; // Format string simple pour l'affichage
  estimatedDepartureTime?: Timestamp | Date | string;
  estimatedArrivalTime?: Timestamp | Date | string;
  actualDepartureTime?: Timestamp | Date | string;
  actualArrivalTime?: Timestamp | Date | string;
  
  // Relation Voiture
  carId: string;
  car?: Car; 
  
  // Statut (incluant 'in_progress')
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled';
  
  // Etapes du trajet
  steps?: any[];
  
  // M√©tadonn√©es
  createdAt?: any;
  updatedAt?: any;
}

@Injectable({ providedIn: 'root' })
export class FirestoreService {
  private firestore = inject(Firestore);

  // --- VOITURES (CARS) ---

  async getUserCars(userId: string): Promise<Car[]> {
    const carsRef = collection(this.firestore, 'cars');
    const q = query(carsRef, where('ownerId', '==', userId));
    const snapshot = await getDocs(q);
    return snapshot.docs.map(d => ({ id: d.id, ...d.data() } as Car));
  }

  // Alias observable
  getCars(userId: string): Observable<Car[]> {
    const carsRef = collection(this.firestore, 'cars');
    const q = query(carsRef, where('ownerId', '==', userId));
    return collectionData(q, { idField: 'id' }) as Observable<Car[]>;
  }

  async addCar(car: Car): Promise<void> {
    const carsRef = collection(this.firestore, 'cars');
    await addDoc(carsRef, car);
  }

  async updateCar(car: Car): Promise<void> {
    if (!car.id) return;
    const carDoc = doc(this.firestore, 'cars', car.id);
    const { id, ...data } = car;
    await updateDoc(carDoc, data as any);
  }

  async deleteCar(carId: string): Promise<void> {
    const carDoc = doc(this.firestore, 'cars', carId);
    await deleteDoc(carDoc);
  }

  // --- TRAJETS (TRIPS) ---

  getTrips(userId: string): Observable<Trip[]> {
    // On cherche par userId OU companyId (selon votre logique m√©tier)
    // Pour simplifier ici, on suppose que userId stocke l'ID du propri√©taire
    const tripsRef = collection(this.firestore, 'trips');
    const q = query(tripsRef, where('companyId', '==', userId)); 
    // Si √ßa ne marche pas, essayez 'driverId' ou 'userId' selon votre base
    return collectionData(q, { idField: 'id' }) as Observable<Trip[]>;
  }

  async addTrip(trip: any): Promise<string> {
    // 'any' ici permet d'accepter les objets complexes de vos composants
    // sans se battre avec le typage strict pour l'instant.
    // On s'assure juste d'avoir les champs minimaux pour l'affichage.
    
    const enrichedTrip = {
      ...trip,
      // Fallbacks pour garantir la compatibilit√©
      userId: trip.userId || trip.driverId || trip.companyId,
      departure: trip.departure || trip.departureCity || '',
      arrival: trip.arrival || trip.arrivalCity || '',
      date: trip.date || new Date().toISOString(),
      status: trip.status || 'pending',
      createdAt: new Date()
    };

    const tripsRef = collection(this.firestore, 'trips');
    const docRef = await addDoc(tripsRef, enrichedTrip);
    return docRef.id;
  }

  async updateTrip(trip: Partial<Trip> | any): Promise<void> {
    if (!trip.id) return;
    const tripDoc = doc(this.firestore, 'trips', trip.id);
    const { id, ...data } = trip;
    await updateDoc(tripDoc, data);
  }

  async deleteTrip(tripId: string): Promise<void> {
    const tripDoc = doc(this.firestore, 'trips', tripId);
    await deleteDoc(tripDoc);
  }
}


====== Fichier : ./src/app/services/chat.ts ======
import { Injectable } from '@angular/core';

@Injectable({
  providedIn: 'root',
})
export class Chat {
  
}


====== Fichier : ./src/app/services/collaboration.service.ts ======
import { Injectable, inject } from '@angular/core';
import { Firestore, collection, addDoc, query, where, getDocs, doc, updateDoc, deleteDoc, collectionData } from '@angular/fire/firestore';
import { Observable, combineLatest, map, of, tap } from 'rxjs';
import { AppUser } from '../interfaces/user.interface';

export interface CollaborationRequest {
  id?: string;
  fromUserId: string;
  toUserId: string;
  status: 'pending' | 'accepted' | 'rejected';
  createdAt: any;
  fromUser?: AppUser;
  toUser?: AppUser;
}

@Injectable({
  providedIn: 'root'
})
export class CollaborationService {
  private firestore = inject(Firestore);

  // --- ENVOI ---
  async sendRequest(currentUserId: string, targetUserId: string) {
    console.log(`Envoi demande de ${currentUserId} vers ${targetUserId}`);
    const requestsRef = collection(this.firestore, 'collaboration_requests');
    
    const q = query(requestsRef, 
      where('fromUserId', '==', currentUserId), 
      where('toUserId', '==', targetUserId)
    );
    const snapshot = await getDocs(q);
    
    if (!snapshot.empty) {
      console.warn('Demande d√©j√† existante');
      throw new Error('Une demande existe d√©j√†.');
    }

    return addDoc(requestsRef, {
      fromUserId: currentUserId,
      toUserId: targetUserId,
      status: 'pending',
      createdAt: new Date()
    });
  }

  // --- LECTURE (Pending) ---
  
  // M√©thode principale avec logs
  getPendingRequestsForUser(userId: string): Observable<CollaborationRequest[]> {
    console.log(`üîç R√©cup√©ration demandes en attente pour: ${userId}`);
    const requestsRef = collection(this.firestore, 'collaboration_requests');
    const q = query(requestsRef, where('toUserId', '==', userId), where('status', '==', 'pending'));
    
    return (collectionData(q, { idField: 'id' }) as Observable<CollaborationRequest[]>).pipe(
      tap(results => console.log(`   üëâ R√©sultats trouv√©s: ${results.length}`, results))
    );
  }

  // ALIAS pour compatibilit√© (fixe l'erreur TS2339)
  getPendingRequests(userId: string): Observable<CollaborationRequest[]> {
    return this.getPendingRequestsForUser(userId);
  }

  // --- LECTURE (Accepted) ---
  getAcceptedCollaborations(userId: string): Observable<CollaborationRequest[]> {
    const requestsRef = collection(this.firestore, 'collaboration_requests');
    
    const q1 = query(requestsRef, where('toUserId', '==', userId), where('status', '==', 'accepted'));
    const q2 = query(requestsRef, where('fromUserId', '==', userId), where('status', '==', 'accepted'));
    
    const received$ = collectionData(q1, { idField: 'id' }) as Observable<CollaborationRequest[]>;
    const sent$ = collectionData(q2, { idField: 'id' }) as Observable<CollaborationRequest[]>;

    return combineLatest([received$, sent$]).pipe(
      map(([r, s]) => [...r, ...s])
    );
  }

  // --- ACTIONS (Accept/Decline) ---

  async updateRequestStatus(requestId: string, status: 'accepted' | 'rejected') {
    console.log(`üìù Mise √† jour demande ${requestId} -> ${status}`);
    const docRef = doc(this.firestore, 'collaboration_requests', requestId);
    return updateDoc(docRef, { status });
  }

  // ALIAS pour compatibilit√© (fixe l'erreur TS2339)
  async acceptRequest(requestId: string) {
    return this.updateRequestStatus(requestId, 'accepted');
  }

  // ALIAS pour compatibilit√© (fixe l'erreur TS2339)
  async declineRequest(requestId: string) {
    return this.updateRequestStatus(requestId, 'rejected');
  }

  // --- SUPPRESSION ---
  async deleteCollaboration(requestId: string) {
    console.log(`üóëÔ∏è Suppression collaboration ${requestId}`);
    const docRef = doc(this.firestore, 'collaboration_requests', requestId);
    return deleteDoc(docRef);
  }

  // --- UTILISATEURS ---
  getAllUsers(): Observable<AppUser[]> {
    const usersRef = collection(this.firestore, 'users');
    return collectionData(usersRef, { idField: 'uid' }) as Observable<AppUser[]>;
  }

  // --- SHARED TRIPS (Fixe l'erreur TS2339) ---
  getSharedTripsForUser(userId: string): Observable<any[]> {
    // Placeholder pour √©viter l'erreur de compilation
    return of([]); 
  }
}


====== Fichier : ./src/app/interfaces/collaboration-request.interface.ts ======
import { Timestamp } from '@angular/fire/firestore';

export interface PackageDetails {
  id: string;
  weight: number;
  description: string;
}

export interface CollaborationRequest {
  id: string;
  requesterCompanyId: string;
  targetCompanyId: string;
  targetTripId: string;
  packageDetails: PackageDetails;
  proposedAmount: number;
  status: 'pending' | 'accepted' | 'rejected';
  createdAt: Timestamp;
  acceptedAt?: Timestamp;
  rejectedAt?: Timestamp;
}


====== Fichier : ./src/app/interfaces/collaboration.interface.ts ======
export type CollaborationStatus = 'pending' | 'accepted' | 'rejected';

export interface Collaboration {
  id?: string;
  participants: string[]; // [userA, userB]
  requesterId: string;
  targetId: string;
  status: CollaborationStatus;
  createdAt?: any; // Timestamp
}


====== Fichier : ./src/app/interfaces/user.interface.ts ======
export interface AppUser {
  uid: string;
  email: string;
  displayName?: string;
  photoURL?: string;
  role?: 'transporteur' | 'expediteur' | 'admin';
  phoneNumber?: string;
}


====== Fichier : ./src/app/interfaces/trip.interface.ts ======
import { Timestamp } from '@angular/fire/firestore';

export interface TripStep {
  city: string;
  estimatedTime: string;
}

export type TripStatus = 'pending' | 'in_progress' | 'completed' | 'cancelled';

export interface Trip {
  id?: string;
  carId: string;
  companyId: string;
  driverId: string;
  departureCity: string;
  arrivalCity: string;
  estimatedDepartureTime: Timestamp;
  estimatedArrivalTime: Timestamp;
  actualDepartureTime?: Timestamp;
  actualArrivalTime?: Timestamp;
  status: TripStatus;
  steps: TripStep[];
  createdAt?: Timestamp;
  updatedAt?: Timestamp;
}


====== Fichier : ./src/app/interfaces/car.interface.ts ======
export interface Car {
  id?: string;
  ownerId: string;
  brand: string; // On utilise 'brand' officiellement
  make?: string; // Alias pour compatibilit√©
  model: string;
  licensePlate: string;
  capacity: number;
  status: 'available' | 'maintenance' | 'busy';
  active?: boolean; // Pour l'affichage UI
}


====== Fichier : ./src/main.ts ======
import { bootstrapApplication } from '@angular/platform-browser';
import { AppComponent } from './app/app.component';
import { appConfig } from './app/app.config';

bootstrapApplication(AppComponent, appConfig)
  .catch((err) => console.error(err));


====== Fichier : ./src/styles.css ======
@import "leaflet/dist/leaflet.css";
@tailwind base;
@tailwind components;
@tailwind utilities;
/* You can add global styles to this file, and also import other style files */


====== Fichier : ./src/environments/environment.ts ======
export const environment = {
  production: false,
  firebaseConfig: {
  apiKey: "AIzaSyD8C-_dQV26aCyoAaBrhyTfILhB3xup_KA",
  authDomain: "colishare.firebaseapp.com",
  databaseURL: "https://colishare-default-rtdb.firebaseio.com",
  projectId: "colishare",
  storageBucket: "colishare.firebasestorage.app",
  messagingSenderId: "842349898218",
  appId: "1:842349898218:web:86d4807652626e8c6b2a93",
  measurementId: "G-XR2SNZLHSS"
  },
  supabaseConfig: {
    // CL√â SECR√àTE UTILIS√âE TEMPORAIREMENT POUR LE D√âVELOPPEMENT. DOIT √äTRE REMPLAC√âE PAR LA CL√â PUBLIQUE + RLS EN PROD.
    url: 'https://qailxxltsofkgtfkgzhv.supabase.co',
    key: 'sb_secret_Qxw6yEx9L0hDSNg6uZo4Yg_GvmWX68x', 
    bucket: 'propositionspourkerkennah' 
  }
};


