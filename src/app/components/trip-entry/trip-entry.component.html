<div class="p-6">
  <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">
    ğŸ“ Enregistrement d'un Nouveau Trajet
  </h2>

  <!-- MESSAGES DE SUCCÃˆS/ERREUR -->
  <div *ngIf="successMessage" class="mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg flex items-center gap-3 animate-pulse">
    <span class="text-2xl">âœ…</span>
    <span class="font-medium">{{ successMessage }}</span>
  </div>

  <div *ngIf="errorMessage" class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg flex items-center gap-3">
    <span class="text-2xl">âŒ</span>
    <span class="font-medium">{{ errorMessage }}</span>
  </div>

  <div class="bg-white p-6 rounded-lg shadow-xl max-w-4xl mx-auto">
    <form [formGroup]="tripForm" (ngSubmit)="onSubmit()" class="space-y-6">
      
      <!-- Voiture -->
      <div>
        <label for="carId" class="block text-sm font-medium text-gray-700 mb-1">
          ğŸš— Voiture AssignÃ©e <span class="text-red-500">*</span>
        </label>
        <select
          id="carId"
          formControlName="carId"
          class="w-full border border-gray-300 rounded-md shadow-sm p-2 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          [class.border-red-500]="tripForm.get('carId')?.invalid && tripForm.get('carId')?.touched"
        >
          <option value="" disabled>SÃ©lectionner un vÃ©hicule</option>
          <ng-container *ngIf="availableCars$ | async as cars">
            <option *ngFor="let car of cars" [value]="car.id">
              {{ car.make }} {{ car.model }} ({{ car.licensePlate }})
            </option>
          </ng-container>
        </select>
        <div
          *ngIf="tripForm.get('carId')?.invalid && tripForm.get('carId')?.touched"
          class="text-red-500 text-xs mt-1"
        >
          âš ï¸ La sÃ©lection de la voiture est obligatoire.
        </div>
      </div>

      <!-- VILLES -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <app-city-select
            formControlName="departureCity"
            label="Ville de DÃ©part"
            icon="ğŸš€"
            placeholder="Tapez pour rechercher..."
            [required]="true"
          ></app-city-select>
          <div
            *ngIf="tripForm.get('departureCity')?.invalid && tripForm.get('departureCity')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            âš ï¸ La ville de dÃ©part est obligatoire.
          </div>
        </div>

        <div>
          <app-city-select
            formControlName="arrivalCity"
            label="Ville d'ArrivÃ©e"
            icon="ğŸ"
            placeholder="Tapez pour rechercher..."
            [required]="true"
          ></app-city-select>
          <div
            *ngIf="tripForm.get('arrivalCity')?.invalid && tripForm.get('arrivalCity')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            âš ï¸ La ville d'arrivÃ©e est obligatoire.
          </div>
        </div>
      </div>

      <!-- Dates -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            â° Heure de DÃ©part <span class="text-red-500">*</span>
          </label>
          <input
            type="datetime-local"
            formControlName="estimatedDepartureTime"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="tripForm.get('estimatedDepartureTime')?.invalid && tripForm.get('estimatedDepartureTime')?.touched"
          />
          <div
            *ngIf="tripForm.get('estimatedDepartureTime')?.invalid && tripForm.get('estimatedDepartureTime')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            âš ï¸ L'heure de dÃ©part est obligatoire.
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            â±ï¸ Heure d'ArrivÃ©e <span class="text-red-500">*</span>
          </label>
          <input
            type="datetime-local"
            formControlName="estimatedArrivalTime"
            class="w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-blue-500"
            [class.border-red-500]="tripForm.get('estimatedArrivalTime')?.invalid && tripForm.get('estimatedArrivalTime')?.touched"
          />
          <div
            *ngIf="tripForm.get('estimatedArrivalTime')?.invalid && tripForm.get('estimatedArrivalTime')?.touched"
            class="text-red-500 text-xs mt-1"
          >
            âš ï¸ L'heure d'arrivÃ©e est obligatoire.
          </div>
        </div>
      </div>

      <!-- Ã‰tapes -->
      <div class="border border-gray-200 p-4 rounded-lg bg-gray-50">
        <h4 class="text-lg font-semibold mb-3 text-gray-700">
          ğŸ›‘ Ã‰tapes IntermÃ©diaires (Optionnel)
        </h4>
        <div formArrayName="steps" class="space-y-3">
          <div
            *ngFor="let stepGroup of steps.controls; let i = index"
            [formGroupName]="i"
            class="flex items-center gap-3 p-3 bg-white rounded shadow-sm"
          >
            <div class="flex-1">
              <input
                type="text"
                formControlName="city"
                placeholder="Ville de l'Ã©tape {{ i + 1 }}"
                class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div class="w-32">
              <input
                type="time"
                formControlName="estimatedTime"
                class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <button
              type="button"
              (click)="removeStep(i)"
              class="text-red-500 hover:text-red-700 text-xl font-bold transition"
              title="Supprimer cette Ã©tape"
            >
              âœ•
            </button>
          </div>
        </div>
        <button
          type="button"
          (click)="addStep()"
          class="mt-3 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition font-medium"
        >
          â• Ajouter une Ã©tape
        </button>
      </div>

      <!-- Boutons -->
      <div class="flex gap-4">
        <button
          type="submit"
          [disabled]="tripForm.invalid || loading"
          class="flex-1 px-6 py-3 text-white font-semibold rounded-lg shadow-md transition"
          [ngClass]="tripForm.invalid || loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'"
        >
          <span *ngIf="!loading">âœ… Enregistrer le Trajet</span>
          <span *ngIf="loading">â³ Enregistrement en cours...</span>
        </button>

        <button
          type="button"
          (click)="cancelForm()"
          [disabled]="loading"
          class="px-8 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed"
        >
          âŒ Annuler
        </button>
      </div>
    </form>
  </div>
</div>
